import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第20弾・Vol.19 & Vol.21 K4シナリオ完結編）
# ==========================================
fixes = {
    # ---------------------------
    # 第3章 AWS Vol.19 (ch3_aws_vol19.json)
    # ---------------------------
    "Q3-AWS-V19-01": { # 組織変革
        "options": [
            "テストチームのスキル不足を補うため、手動テストの人員を倍増させ、人海戦術でカバーする（ブルックスの法則の無視）",
            "テストチームの役割を「実行部隊」から「品質イネーブラー（支援者）」へと再定義する。開発チームの中に「SET（Software Engineer in Test）」として技術力の高いメンバーを配置し、自動テストの実装は開発者とペアで行わせ、既存の手動テスターには探索的テストやユーザビリティ確認に集中させる",
            "テストを全て外部ベンダーに委託し、社内のテストチームはベンダー管理のみを行う（技術空洞化）",
            "品質担保の責任をすべて開発チームに移譲し、QAチームを廃止してコストを削減する（品質ガバナンスの崩壊）"
        ],
        "answer": ["テストチームの役割を「実行部隊」から「品質イネーブラー（支援者）」へと再定義する。開発チームの中に「SET（Software Engineer in Test）」として技術力の高いメンバーを配置し、自動テストの実装は開発者とペアで行わせ、既存の手動テスターには探索的テストやユーザビリティ確認に集中させる"]
    },
    "Q3-AWS-V19-02": { # カオスエンジニアリング導入
        "options": [
            "「本番環境でこそ意味がある」として、最初から本番のピークタイムに障害注入を行い、リアルなデータを取る（ビッグバン導入・高リスク）",
            "まずは「ステージング環境」で実施し、かつ「ゲームデー（GameDay）」としてイベント化して、楽しみながら障害対応を学ぶ機会を作る。自信がついてから本番環境での小規模実験へと段階を進める",
            "カオスエンジニアリングはリスクが高すぎるため導入を諦め、机上シミュレーションのみで済ませる",
            "開発環境（Dev）のみで実施し、本番環境では決して行わない（構成差異によるリスク見逃し）"
        ],
        "answer": ["まずは「ステージング環境」で実施し、かつ「ゲームデー（GameDay）」としてイベント化して、楽しみながら障害対応を学ぶ機会を作る。自信がついてから本番環境での小規模実験へと段階を進める"]
    },

    # ---------------------------
    # 第1章 金融 Vol.21 (ch1_finance_vol21.json)
    # ---------------------------
    "Q1-FIN-V21-01": { # 1円バグのコンティンジェンシー
        "options": [
            "影響範囲が広い修正をテスト不十分なまま本番適用するリスクは許容できないため、システム修正は見送る。その代わり、影響を受ける5,000人のリストを抽出し、翌月以降に差額を補填（入金）する「業務運用による回避策」をビジネス部門と合意する",
            "「たかが1円」であるため、顧客への告知も補填も行わず、次回の定期リリースでひっそりと修正する（コンプライアンス違反）",
            "テストを省略して緊急パッチ（ホットフィックス）を適用し、もし障害が起きたらその時にロールバックする（ギャンブル）",
            "バッチ処理の日程を1週間延期するよう、全銀ネットや他行などの外部接続先に調整を申し入れる（実現可能性が低い）"
        ],
        "answer": ["影響範囲が広い修正をテスト不十分なまま本番適用するリスクは許容できないため、システム修正は見送る。その代わり、影響を受ける5,000人のリストを抽出し、翌月以降に差額を補填（入金）する「業務運用による回避策」をビジネス部門と合意する"]
    },

    # ---------------------------
    # 第3章 クラウド Vol.21 (ch3_cloud_vol21.json)
    # ---------------------------
    "Q3-CLD-V21-01": { # QA採用判断
        "options": [
            "採用すべき。彼の厳格な姿勢は、緩みがちな開発チームを引き締め、規律をもたらすだろう",
            "採用すべきではない。A氏の「ゲートキーパー」としてのマインドセットは、チームの自律性とスピードを重視するDevOpsカルチャーと真っ向から対立し、チーム内に深刻な摩擦（コンフリクト）を生むリスクが高いため",
            "採用すべき。資格を持っているため、知識量でチームをリードできるはずだ",
            "採用すべきではない。技術スキルは高いが、ドキュメント作成能力が低そうだから"
        ],
        "answer": ["採用すべきではない。A氏の「ゲートキーパー」としてのマインドセットは、チームの自律性とスピードを重視するDevOpsカルチャーと真っ向から対立し、チーム内に深刻な摩擦（コンフリクト）を生むリスクが高いため"]
    },

    # ---------------------------
    # 第3章 医療 Vol.21 (ch3_medical_vol21.json)
    # ---------------------------
    "Q3-MED-V21-01": { # 医療アジャイルと規制
        "options": [
            "文書作成専門のチームを別途雇い、開発とは完全に切り離してあと追いで文書を作らせる（プロセスの乖離リスク）",
            "開発プロセスと文書作成プロセスを分離せず、JiraやGitHubなどのALMツール上で要件・テスト・結果を紐付け、そこから規制当局提出用のドキュメントを自動生成（Documentation as Code）するパイプラインを構築し、監査対応コストを劇的に下げる",
            "法規制に対応するため、アジャイル開発を諦めてウォーターフォールに戻し、リリース頻度を年1回に下げる（ビジネス価値の毀損）",
            "規制当局に対して「アジャイルなので文書は作れません」と交渉する"
        ],
        "answer": ["開発プロセスと文書作成プロセスを分離せず、JiraやGitHubなどのALMツール上で要件・テスト・結果を紐付け、そこから規制当局提出用のドキュメントを自動生成（Documentation as Code）するパイプラインを構築し、監査対応コストを劇的に下げる"]
    },

    # ---------------------------
    # 第1章 一般 Vol.19 (ch1_general_vol19.json)
    # ---------------------------
    "Q1-GEN-V19-01": { # メンテ不能な自動テスト
        "options": [
            "コードを書かなくて良い「録画再生（キャプチャ＆リプレイ）ツール」に乗り換え、壊れたら録り直す運用にする（根本解決にならない）",
            "「ページオブジェクトパターン（Page Object Pattern）」を導入し、画面要素の定義（セレクタ）をページごとのクラスに集約・隠蔽する。テストシナリオからはそのクラスのメソッドを呼ぶだけにすることで、画面変更の影響をクラス内部に閉じ込める",
            "UIテストは壊れやすいので全て廃止し、手動テストのみに戻す",
            "要素特定に「絶対パス（Absolute XPath）」を使用し、要素の場所を厳密に指定する（さらに壊れやすくなる）"
        ],
        "answer": ["「ページオブジェクトパターン（Page Object Pattern）」を導入し、画面要素の定義（セレクタ）をページごとのクラスに集約・隠蔽する。テストシナリオからはそのクラスのメソッドを呼ぶだけにすることで、画面変更の影響をクラス内部に閉じ込める"]
    },

    # ---------------------------
    # 第1章 医療 Vol.19 (ch1_medical_vol19.json)
    # ---------------------------
    "Q1-MED-V19-01": { # 医療機器脆弱性対応
        "options": [
            "発生確率が低いとしても、危害の重大度（過剰投与による死亡リスク）が「破滅的」であるため、リスク受容は不可とする。設計変更による対策（認証強化など）を行い、リリースを延期する",
            "開発チームの主張通り、発生確率が極めて低いため「広義のリスク受容」として扱い、添付文書（マニュアル）に「ペアリング中は周囲に注意すること」という警告を追記してリリースする（安全設計の優先順位違反）",
            "脆弱性は「既知の不具合」としてリリースノートに小さく記載し、ユーザーの自己責任とする",
            "Bluetooth機能を無効化して出荷し、後日パッチで対応する（意図した使用目的を満たさない可能性）"
        ],
        "answer": ["発生確率が低いとしても、危害の重大度（過剰投与による死亡リスク）が「破滅的」であるため、リスク受容は不可とする。設計変更による対策（認証強化など）を行い、リリースを延期する"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第20弾：問題データの修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()