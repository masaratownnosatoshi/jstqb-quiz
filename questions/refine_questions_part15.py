import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第15弾・Vol.11 K4分析編）
# ==========================================
fixes = {
    # ---------------------------
    # 第3章 クラウド Vol.11 (ch3_cloud_vol11.json)
    # ---------------------------
    "Q3-CLD-V11-01": { # QAの立ち位置変革
        "options": [
            "さらに厳格な品質ゲートを設け、QAの承認なしには開発環境へのマージすら許可しない体制にする（ブロッカー化の強化）",
            "「QAは品質を保証する（Assure）」のではなく、「開発者が品質を作り込むのを支援する（Assist）」役割にシフトし、テスト自動化基盤の提供や品質コーチングを行う",
            "QAチームを縮小し、開発者による単体テストのみで品質を担保する方針に切り替える（E2Eテストの軽視）",
            "開発プロセスへの関与を諦め、リリース後の本番監視（Obserbability）のみに注力する"
        ],
        "answer": ["「QAは品質を保証する（Assure）」のではなく、「開発者が品質を作り込むのを支援する（Assist）」役割にシフトし、テスト自動化基盤の提供や品質コーチングを行う"]
    },

    # ---------------------------
    # 第3章 一般 Vol.11 (ch3_general_vol11.json)
    # ---------------------------
    "Q3-GEN-V11-01": { # 毒性のあるメンバーへの対応
        "options": [
            "A氏はスキルが高く替えが効かないため、個人の性格の問題として黙認する",
            "心理的安全性が損なわれ、バグ隠蔽のリスクが高まっている。A氏に対し「態度の改善」を業務命令として伝え、チームの行動規範（Code of Conduct）を再定義して「敬意」を必須項目とする",
            "B氏のスキル不足が原因であると判断し、B氏に追加のトレーニングを課す（被害者を責める）",
            "A氏の性格は変えられないため、A氏を「ご意見番」として隔離し、チームの実務から外す（問題の先送り）"
        ],
        "answer": ["心理的安全性が損なわれ、バグ隠蔽のリスクが高まっている。A氏に対し「態度の改善」を業務命令として伝え、チームの行動規範（Code of Conduct）を再定義して「敬意」を必須項目とする"]
    },
    "Q3-GEN-V11-02": { # 動機付け理論
        "options": [
            "給与を一律アップする（衛生要因への対処であり、長続きしない）",
            "開発チームとの合同振り返りで、テスターの貢献（バグ発見によるリスク回避額など）を可視化し、チーム全体から承認される場を作る（承認欲求）",
            "テスト工程の一部を「探索的テスト」や「自動化開発」などのクリエイティブなタスクに置き換え、仕事自体のやりがい（達成感）を高める",
            "福利厚生として社内イベントを増やし、親睦を深める（動機付け要因ではない）"
        ],
        "answer": [
            "開発チームとの合同振り返りで、テスターの貢献（バグ発見によるリスク回避額など）を可視化し、チーム全体から承認される場を作る（承認欲求）",
            "テスト工程の一部を「探索的テスト」や「自動化開発」などのクリエイティブなタスクに置き換え、仕事自体のやりがい（達成感）を高める"
        ]
    },

    # ---------------------------
    # 第1章 AWS Vol.11 (ch1_aws_vol11.json)
    # ---------------------------
    "Q1-AWS-V11-01": { # クラウド性能テストの不安定性
        "options": [
            "テストスクリプトの待機時間（Wait）設定が短すぎる",
            "マルチテナント環境における「Noisy Neighbor（近隣の騒音）」影響や、バーストインスタンス（T系）のCPUクレジット枯渇",
            "AWSのリージョン全体で障害が発生している",
            "ロードバランサー（ALB）の暖機運転（Pre-warming）が完了していない"
        ],
        "answer": ["マルチテナント環境における「Noisy Neighbor（近隣の騒音）」影響や、バーストインスタンス（T系）のCPUクレジット枯渇"]
    },

    # ---------------------------
    # 第1章 金融 Vol.11 (ch1_finance_vol11.json)
    # ---------------------------
    "Q1-FIN-V11-01": { # 性能要件未達の判断
        "options": [
            "計測期間を短縮し、たまたま性能が良かった時間帯のデータのみを報告書に採用する（チェリーピッキング）",
            "競合他社が新機能を来週出すため、0.5秒の遅延による顧客離脱リスク（ビジネス損失）と、リリース延期による機会損失を比較秤量し、許容範囲内であれば「条件付きリリース」とする",
            "「運用開始後にDBのキャッシュが効いてくれば速くなるはずだ」という希望的観測に基づき、現状のままリリースする",
            "本番環境のサーバースペックを暫定的に上げ（スケールアップ）、コスト増を許容して性能要件をクリアする（コストリスクの受容）"
        ],
        "answer": ["競合他社が新機能を来週出すため、0.5秒の遅延による顧客離脱リスク（ビジネス損失）と、リリース延期による機会損失を比較秤量し、許容範囲内であれば「条件付きリリース」とする"]
    },

    # ---------------------------
    # 第1章 一般 Vol.11 (ch1_general_vol11.json)
    # ---------------------------
    "Q1-GEN-V11-01": { # 終了直前のバグ多発
        "options": [
            "品質基準を満たしていないため、リリースを強行すると市場障害のリスクが高いと判断し、ビジネス部門に「機能（スコープ）の縮小」を提案して、安定している機能のみを部分リリースする",
            "重要度「中」の定義を一時的に厳しくし、見かけ上の残存バグ数を減らして終了基準をクリアする（ゲーミング）",
            "テスト基準を緩和して、残っているバグを「仕様」としてクローズする",
            "バグ修正（デバッグ）にリソースを集中させるため、バグ確認以外のテスト実行を一時停止する（品質確認の放棄）"
        ],
        "answer": ["品質基準を満たしていないため、リリースを強行すると市場障害のリスクが高いと判断し、ビジネス部門に「機能（スコープ）の縮小」を提案して、安定している機能のみを部分リリースする"]
    },
    "Q1-GEN-V11-02": { # 結合テストのバグ摘出率低
        "options": [
            "結合テストの網羅性が低く、インターフェース周りのバグがスルーされている可能性がある",
            "単体テストの品質が高いため、結合テストで見つけるバグが減っている（理想的な状態）",
            "スタブ/ドライバの品質が悪く、実際の連携挙動を模倣できていない可能性がある",
            "結合テストの工程を廃止し、システムテストにリソースを統合する"
        ],
        "answer": [
            "結合テストの網羅性が低く、インターフェース周りのバグがスルーされている可能性がある",
            "スタブ/ドライバの品質が悪く、実際の連携挙動を模倣できていない可能性がある"
        ]
    },
    "Q1-GEN-V11-03": { # パーキンソンの法則とバッファ
        "options": [
            "安全係数をさらに上乗せし、見積もりの2倍の期間を確保する（スチューデント症候群の助長）",
            "過剰なバッファは「作業の膨張（時間を使い切るまでダラダラやる）」を招くため、WBSを詳細化させて根拠のないバッファを特定・削減し、代わりにプロジェクト全体としての共有バッファ（Management Reserve）を設ける",
            "「類推見積もり（Analogous Estimating）」を用いて、過去の実績値ベースで工数を修正させる",
            "バッファを各タスク担当者に管理させ、個人の責任で納期を守らせる（各個撃破のリスク）"
        ],
        "answer": ["過剰なバッファは「作業の膨張（時間を使い切るまでダラダラやる）」を招くため、WBSを詳細化させて根拠のないバッファを特定・削減し、代わりにプロジェクト全体としての共有バッファ（Management Reserve）を設ける"]
    },

    # ---------------------------
    # 第2章 一般 Vol.11 (ch2_general_vol11.json)
    # ---------------------------
    "Q2-GEN-V11-01": { # 殺虫剤のパラドックス
        "options": [
            "自動テストは同じことしか繰り返さないため、新しいバグを見つける能力が低下している。自動化は「品質の担保（回帰）」に留め、浮いた工数を「探索的テスト」や「新機能のテスト設計」に回すべきである",
            "自動テストのシナリオにランダム性を持たせ、毎回異なるデータを入力するように修正する（ファジングの導入）",
            "自動化率を100%まで引き上げ、人間の介在を完全になくすことでミスを減らす",
            "テスト工程を開発工程の中に統合し、シフトレフトを加速させる"
        ],
        "answer": ["自動テストは同じことしか繰り返さないため、新しいバグを見つける能力が低下している。自動化は「品質の担保（回帰）」に留め、浮いた工数を「探索的テスト」や「新機能のテスト設計」に回すべきである"]
    },
    "Q2-GEN-V11-02": { # レビュー指摘密度ゼロ
        "options": [
            "Bチームのメンバーは全員ベテランであり、阿吽の呼吸で開発しているためレビューは不要である",
            "Bチームのレビューが形骸化しており、ザル（素通り）になっている可能性がある",
            "Bチームのレビューアのスキル不足、または心理的安全性（批判を恐れる）の欠如を疑い、モデレーターを外部から派遣して活性化させる",
            "Bチームはペアプログラミングを導入しているため、コードレビュー工程自体が省略されている可能性がある"
        ],
        "answer": [
            "Bチームのレビューが形骸化しており、ザル（素通り）になっている可能性がある",
            "Bチームのレビューアのスキル不足、または心理的安全性（批判を恐れる）の欠如を疑い、モデレーターを外部から派遣して活性化させる"
        ]
    },

    # ---------------------------
    # 第2章 医療 Vol.11 (ch2_medical_vol11.json)
    # ---------------------------
    "Q2-MED-V11-01": { # 再現しない市場不具合
        "options": [
            "不具合報告書を発行するが、発生頻度が低いため「低リスク」と分類し、是正処置（CAPA）の対象外とする",
            "「再現しない」で放置せず、市場からのフィードバック（Post-market Surveillance）として苦情記録に残し、リスク評価（危害の程度）を見直した上で、更なる調査（ログ収集機能の追加配布など）を決定する",
            "次期バージョンでの修正項目リスト（Backlog）に追加するが、現行ユーザーへの通知は行わない（サイレントフィックス）",
            "操作ログ機能が実装されていないため、原因特定は不可能と判断し、「仕様制限事項」としてマニュアルに記載する"
        ],
        "answer": ["「再現しない」で放置せず、市場からのフィードバック（Post-market Surveillance）として苦情記録に残し、リスク評価（危害の程度）を見直した上で、更なる調査（ログ収集機能の追加配布など）を決定する"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第15弾：K4分析問題の修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()