import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第46弾・Vol.90-92 最終仕上げ）
# ==========================================
fixes = {
    # ---------------------------
    # 第1章 AWS Vol.92 (ch1_aws_vol92.json)
    # ---------------------------
    "Q1-AWS-V92-01": { # 変更管理アンチパターン
        "options": [
            "本番環境へのアクセスを全員禁止する（緊急対応ができなくなる）",
            "インフラをコード化（IaC: Terraform/CloudFormation）し、変更は必ずコードレビューとCI/CDパイプライン経由で行うように強制する。さらにAWS Configで「手動変更（ドリフト）」を検知してアラートを飛ばす",
            "操作ログを毎日目視チェックする（工数が膨大で形骸化する）",
            "手動操作自体は禁止せず、運用担当者の注意深さに依存した運用を継続する（再発防止の欠如）" # 「犯人処罰」を修正
        ],
        "answer": ["インフラをコード化（IaC: Terraform/CloudFormation）し、変更は必ずコードレビューとCI/CDパイプライン経由で行うように強制する。さらにAWS Configで「手動変更（ドリフト）」を検知してアラートを飛ばす"]
    },

    # ---------------------------
    # 第1章 一般 Vol.92 (ch1_general_vol92.json)
    # ---------------------------
    "Q1-GEN-V92-01": { # ポリシー矛盾の解消
        "options": [
            "プロジェクトの現実は厳しいので、ポリシーを無視して戦略を実行する（コンプライアンス違反）",
            "テストポリシーを書き換えて「納期第一」にする（ポリシーの私物化）",
            "このプロジェクトの特殊事情（短納期・競合対抗など）をステークホルダーに説明し、今回に限ってポリシーからの逸脱（Exception）を承認してもらうプロセスを経る",
            "現実を無視してポリシー通りの計画を立てるが、実行段階で破綻する（計画の形骸化）" # 「秘密裏」を修正
        ],
        "answer": ["このプロジェクトの特殊事情（短納期・競合対抗など）をステークホルダーに説明し、今回に限ってポリシーからの逸脱（Exception）を承認してもらうプロセスを経る"]
    },

    # ---------------------------
    # 第3章 一般 Vol.92 (ch3_general_vol92.json)
    # ---------------------------
    "Q3-GEN-V92-01": { # 自動化リーダー要件
        "options": [
            "ひたすらコードを書き続ける集中力（視野狭窄）",
            "「自動化すべきもの」と「すべきでないもの」をビジネス価値の観点で判断し、手動テストチームや開発者と協調してプロセス全体を最適化するコミュニケーション能力",
            "既存のテストプロセスを無視して、自分の好きなツールでスクリプトを書き直す独断力（チームワークの欠如）", # 「誰とも話さず」を修正
            "特定のプログラミング言語に関する深い知識のみ（プロセス改善の視点が欠如）" # 「タイピング」を修正
        ],
        "answer": ["「自動化すべきもの」と「すべきでないもの」をビジネス価値の観点で判断し、手動テストチームや開発者と協調してプロセス全体を最適化するコミュニケーション能力"]
    },

    # ---------------------------
    # 第3章 一般 Vol.90 (ch3_general_vol90.json)
    # ---------------------------
    "Q3-GEN-V90-01": { # マズロー応用
        "options": [
            "生理的欲求。休暇を与える（一時的対処であり、将来不安は消えない）", # 「食事」を修正
            "安全の欲求。雇用の保証や、長期的なキャリアパスの提示を行う",
            "社会的欲求。チームランチを増やす（帰属意識は高まるが、将来不安の解決にはならない）", # 「パーティー」を修正
            "自己実現の欲求。難しい課題を与える（不安な状態では負担になる）"
        ],
        "answer": ["安全の欲求。雇用の保証や、長期的なキャリアパスの提示を行う"]
    },

    # ---------------------------
    # 第2章 一般 Vol.91 (ch2_general_vol91.json)
    # ---------------------------
    "Q2-GEN-V91-03": { # パイロット評価
        "options": [
            "既存のテストプロセス（フロー）との適合性",
            "ツールを使用するための学習曲線（習得にかかる時間）",
            "ベンダーの知名度や市場シェアだけで判断し、自組織のプロセスとの適合性を検証しない（適合性検証の欠如）", # 「笑顔」を修正
            "生成されるレポートがステークホルダーの要求を満たすか"
        ],
        "answer": ["ベンダーの知名度や市場シェアだけで判断し、自組織のプロセスとの適合性を検証しない（適合性検証の欠如）"]
        # 注: 問題文が「不適切なもの」を選ぶ形式
    },
    "Q2-GEN-V91-04": { # 静的解析運用
        "options": [
            "全ての警告を修正するまでリリース禁止とする（過剰品質・開発停止）",
            "「新規および変更したコード」の警告のみを修正必須とし、既存コードの警告はベースラインとして許容する",
            "ツールを停止する（問題の放置）",
            "警告のフィルタリング設定を行わず、全件を目視確認する（工数爆発）" # 「自動削除」を修正
        ],
        "answer": ["「新規および変更したコード」の警告のみを修正必須とし、既存コードの警告はベースラインとして許容する"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第46弾：Vol.90-92の最終修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルを最適化しました。")

if __name__ == "__main__":
    refine_questions()