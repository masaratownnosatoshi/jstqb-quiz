import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第43弾・選択肢の長文化＆品質向上）
# ==========================================
fixes = {
    # ---------------------------
    # 第1章 一般 Vol.93 (ch1_general_vol93.json)
    # ---------------------------
    "Q1-GEN-V93-01": { # リスクバーンダウン停滞
        "options": [
            "テストの進捗自体は予定通りであったが、リスクレベルの低い機能ばかりがテストされ、重要度の高い欠陥が未発見のまま残っていた可能性がある（誤答：もっともらしい分析だが、バーンダウンが減らない理由としては「ブロック」の方が直接的）", 
            "新たなリスクが識別されたか、あるいは高リスクなテストケースがブロック（実施不可）されており、リスク軽減が進んでいなかった", # 正解
            "開発者がバグを修正していたため、テスト実行が一時的にストップしていた",
            "テストケースの数が多すぎて、グラフの目盛りが合っていなかった"
        ],
        "answer": ["新たなリスクが識別されたか、あるいは高リスクなテストケースがブロック（実施不可）されており、リスク軽減が進んでいなかった"]
    },
    "Q1-GEN-V93-02": { # オフショア進捗報告
        "options": [
            "報告された数値は目標を達成しているが、オフショア拠点特有の「悪い報告を避ける文化」が影響している可能性を考慮し、数値の裏付けとなるエビデンスを確認する（誤答：アクションとしては正しいが、Watermelon Metricの疑いという文脈では正解の方がより具体的）", # これを誤答として配置し、正解と迷わせる
            "数字が良すぎて不自然である（Watermelon Metricの疑い）。探索的テストの結果や、欠陥の発見経緯などの定性的な情報を要求し、本当にテストが行われているか（中身の品質）を確認する", # 正解
            "探索的テストは契約に含まれていないため無視し、定量的な数値報告のみを承認する",
            "テスターを褒める"
        ],
        # 注: 上記の誤答案は正解に近すぎるため、もう少し「誤った判断」に寄せつつ長文にします。
        "options": [
            "報告された数値（実行率・合格率）が目標を達成しているため、プロジェクトは順調であると判断し、探索的テストの結果は参考程度にとどめる（誤答：数字を鵜呑みにするリスク）",
            "数字が良すぎて不自然である（Watermelon Metricの疑い）。探索的テストの結果や、欠陥の発見経緯などの定性的な情報を要求し、本当にテストが行われているか（中身の品質）を確認する",
            "オフショア拠点のスキル不足を疑い、直ちに契約を解除して国内ベンダーに切り替える",
            "探索的テストは実施されていない可能性が高いため、テスト期間を延長して再実施を命じる"
        ],
        "answer": ["数字が良すぎて不自然である（Watermelon Metricの疑い）。探索的テストの結果や、欠陥の発見経緯などの定性的な情報を要求し、本当にテストが行われているか（中身の品質）を確認する"]
    },

    # ---------------------------
    # 第2章 一般 Vol.93 (ch2_general_vol93.json)
    # ---------------------------
    "Q2-GEN-V93-01": { # DRE分析
        "options": [
            "上流工程での欠陥除去率が低いことは問題だが、最終的なシステムテストで90%除去できているため、プロセス全体としての品質保証能力は十分に高く、現状のプロセスを維持すべきである（誤答：コスト効率の視点が欠けている）",
            "下流工程（システムテスト）での除去能力が高く、品質保証の最後の砦が機能しているが、上流（レビュー・単体）での除去率が低すぎるため、手戻りコストが肥大化している（コスト非効率）。上流での除去率向上を目指すべき", # 正解
            "レビューは効果がないので廃止し、そのリソースを全てシステムテストに投入することで、検出率を100%に近づけるべき",
            "単体テストのカバレッジ目標を下げ、より早い段階で結合テストに移行することで、全体のスループットを向上させるべき"
        ],
        "answer": ["下流工程（システムテスト）での除去能力が高く、品質保証の最後の砦が機能しているが、上流（レビュー・単体）での除去率が低すぎるため、手戻りコストが肥大化している（コスト非効率）。上流での除去率向上を目指すべき"]
    },

    # ---------------------------
    # 第1章 一般 Vol.94 (ch1_general_vol94.json)
    # ---------------------------
    "Q1-GEN-V94-01": { # 品質コスト最適化
        "options": [
            "失敗コスト（不適合コスト）の削減のみに注力し、予防コストや評価コストへの投資を最小限に抑えることで、プロジェクト全体の利益率を最大化することを目指す（誤答：長期的にはコスト増になる）",
            "予防コストと評価コスト（適合コスト）に投資することで、より高額な失敗コスト（不適合コスト）を削減し、トータルの品質コストを最小化することを目指す", # 正解
            "失敗コストをゼロにすることを最優先目標とし、どれだけコストがかかっても全ての欠陥をリリース前に除去する",
            "テスト実行（評価コスト）だけに集中投資し、レビュー（予防コスト）は実施しない"
        ],
        "answer": ["予防コストと評価コスト（適合コスト）に投資することで、より高額な失敗コスト（不適合コスト）を削減し、トータルの品質コストを最小化することを目指す"]
    },

    # ---------------------------
    # 第2章 一般 Vol.94 (ch2_general_vol94.json)
    # ---------------------------
    "Q2-GEN-V94-01": { # チェックリスト活用
        "options": [
            "過去のプロジェクトで使用したチェックリストをそのまま流用し、網羅性を確保するために、対象ドキュメントの種類に関わらず全ての項目を確認するようにする（誤答：非効率・形骸化）",
            "レビュー対象の種類（要件、設計、コード等）や、過去の欠陥傾向に合わせて、具体的かつ焦点を絞った質問項目を定義し、定期的に更新する", # 正解
            "インターネットで見つけた汎用的なリストを導入し、カスタマイズせずにそのまま適用することで、業界標準に準拠する",
            "チェックリストは使用せず、レビューアの直感と経験のみに依存する"
        ],
        "answer": ["レビュー対象の種類（要件、設計、コード等）や、過去の欠陥傾向に合わせて、具体的かつ焦点を絞った質問項目を定義し、定期的に更新する"]
    },

    # ---------------------------
    # 第3章 一般 Vol.94 (ch3_general_vol94.json)
    # ---------------------------
    "Q3-GEN-V94-01": { # 評価指標の弊害
        "options": [
            "発見された欠陥の数が増えることで、開発チームの修正負荷が急増し、プロジェクト全体のスケジュールが遅延するリスクがある（誤答：ありそうなリスクだが、質問の意図する「評価指標の弊害」ではない）",
            "テスターと開発者が敵対関係になり、開発者が情報を隠したり、テスターが簡単なバグ報告で数稼ぎをするようになる（ハドソンの法則・コブラ効果）", # 正解
            "テスト担当者のモチベーションが向上し、より難易度の高い欠陥を見つけようとする意欲が湧く",
            "開発者がテストチームに感謝するようになり、協力関係が強化される"
        ],
        "answer": ["テスターと開発者が敵対関係になり、開発者が情報を隠したり、テスターが簡単なバグ報告で数稼ぎをするようになる（ハドソンの法則・コブラ効果）"]
    },

    # ---------------------------
    # 第3章 一般 Vol.95 (ch3_general_vol95.json)
    # ---------------------------
    "Q3-GEN-V95-01": { # メンタリングとコーチング
        "options": [
            "メンタリングは、特定のタスク遂行に必要な技術的スキルを短期間で指導することであり、コーチングは、長期的な視点で人格形成やキャリア開発を支援することである（誤答：定義が逆）",
            "メンタリングは、経験豊富な先輩（メンター）が、キャリアや個人的な成長を含めて長期的に支援・助言すること。\nコーチングは、具体的なスキルやパフォーマンス向上のために、問いかけを通じて相手の能力を引き出すこと", # 正解
            "メンタリングは技術的な指導のみを行い、コーチングは精神的なサポートのみを行う",
            "両者に明確な違いはなく、どちらも上司が部下に対して行う一方的な指導のことである"
        ],
        "answer": ["メンタリングは、経験豊富な先輩（メンター）が、キャリアや個人的な成長を含めて長期的に支援・助言すること。\nコーチングは、具体的なスキルやパフォーマンス向上のために、問いかけを通じて相手の能力を引き出すこと"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第43弾：選択肢の長文化＆推測防止処理を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルを最適化しました。")

if __name__ == "__main__":
    refine_questions()