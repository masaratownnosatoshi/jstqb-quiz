import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第23弾・Vol.29-30 最終完結編）
# ==========================================
fixes = {
    # ---------------------------
    # 第2章 一般 Vol.30 (ch2_general_vol30.json)
    # ---------------------------
    "Q2-GEN-V30-01": { # 欠陥レポートの却下率高
        "options": [
            "リスク：開発者が却下処理に時間を取られ、本物のバグ修正が遅れる（偽陽性による効率低下）。\n改善策：テスト担当者に対し、報告前に仕様書を確認することや、再現手順を確立することを義務付け、無効なレポートをフィルタリングするプロセス（トリアージやリードによる事前確認）を導入する。",
            "リスク：テスト担当者のスキル不足が露見する。\n改善策：テスト担当者を全員入れ替える。",
            "リスク：特になし。\n改善策：現状維持。",
            "リスク：開発チームとテストチームの信頼関係が悪化する。\n改善策：却下率をKPIとして監視し、開発者とテスターの認識齟齬を埋めるための仕様レビュー会を定期開催するか、トリアージ会議での対話を強化する。"
        ],
        "answer": [
            "リスク：開発者が却下処理に時間を取られ、本物のバグ修正が遅れる（偽陽性による効率低下）。\n改善策：テスト担当者に対し、報告前に仕様書を確認することや、再現手順を確立することを義務付け、無効なレポートをフィルタリングするプロセス（トリアージやリードによる事前確認）を導入する。"
        ]
    },

    # ---------------------------
    # 第3章 AWS Vol.30 (ch3_aws_vol30.json)
    # ---------------------------
    "Q3-AWS-V30-01": { # 開発 vs SRE
        "options": [
            "SREの意見を尊重し、バグがゼロになるまでリリースを禁止する（ゼロリスク信仰）",
            "「エラーバジェット（Error Budget）」の概念を導入し、許容できるダウンタイム（バジェット）の範囲内であれば開発チームの判断でリリースして良いが、バジェットを使い切ったらリリースを凍結して信頼性向上に専念する、という客観的な共通ルールを合意させる",
            "開発チームのスピードを優先し、障害対応はSREに一任する（運用への丸投げ）",
            "SREが開発プロセスの上流に入り込み、非機能要件（信頼性・可観測性）の設計レビューを行うことで、手戻りを防ぎつつリリース品質を高める（シフトレフト）"
        ],
        "answer": [
            "「エラーバジェット（Error Budget）」の概念を導入し、許容できるダウンタイム（バジェット）の範囲内であれば開発チームの判断でリリースして良いが、バジェットを使い切ったらリリースを凍結して信頼性向上に専念する、という客観的な共通ルールを合意させる"
        ]
    },

    # ---------------------------
    # 第1章 医療 Vol.30 (ch1_medical_vol30.json)
    # ---------------------------
    "Q1-MED-V30-01": { # AI医療機器テスト戦略
        "options": [
            "(1), (2), (5) のみ（従来通りの構成：AIの特性を無視している）",
            "(1), (2), (3), (4) （AI特性と安全性への対応を強化：リスク分析、規制準拠に加え、確率的挙動に対するモデル評価や専門家評価を組み合わせる）",
            "(2), (5) のみ（規制と効率化を重視：AIのブラックボックス性に対応できない）",
            "(3), (4) のみ（新しいことだけに集中：規制要件（IEC 62304）が抜けている）"
        ],
        "answer": [
            "(1), (2), (3), (4) （AI特性と安全性への対応を強化：リスク分析、規制準拠に加え、確率的挙動に対するモデル評価や専門家評価を組み合わせる）"
        ]
    },

    # ---------------------------
    # 第3章 一般 Vol.29 (ch3_general_vol29.json)
    # ---------------------------
    "Q3-GEN-V29-02": { # モチベーション管理（不適切）
        "options": [
            "テスト担当者の貢献（バグ発見や品質リスクの低減）を正当に評価し、プロジェクト全体に可視化する",
            "プロジェクト初期の要件定義段階からテスト担当者を参画させ、意見を求める（シフトレフトによる参画意識向上）",
            "納期短縮のためにテスト期間を削り、品質の低い製品をリリースしたが、納期を守ったことだけを評価し、テストチームの苦労や品質への懸念には一切触れない（品質軽視による無力感）",
            "スキルアップの機会として、新しいテストツールや技法の導入を奨励する"
        ],
        "answer": [
            "納期短縮のためにテスト期間を削り、品質の低い製品をリリースしたが、納期を守ったことだけを評価し、テストチームの苦労や品質への懸念には一切触れない（品質軽視による無力感）"
        ]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第23弾：Vol.29-30 最終修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()