import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第21弾・Vol.22-25 最終調整）
# ==========================================
fixes = {
    # ---------------------------
    # 第3章 一般 Vol.23 (ch3_general_vol23.json)
    # ---------------------------
    "Q3-GEN-V23-01": { # スキルマトリクス活用
        "options": [
            "スキル不足のメンバーを特定し、教育コストを削減するために「テスト実行のみ」の担当として固定化する（成長機会の剥奪）",
            "チーム全体の「IoTドメイン知識」の不足を補うため、業務知識のトレーニングを提供する、またはドメインエキスパートを採用する",
            "メンバY（知識高・実装良）は優秀すぎるため、チームのバランスを崩すので異動させる",
            "メンバWとXが実装スキルを持っているが、チーム全体としては自動化対応力が不足するリスクがあるため、実装（プログラミング）スキルのトレーニングをVとZに提供する",
            "個人のスキル評価を給与査定に直結させ、競争原理でスキルアップを促す（チームワークの阻害リスク）"
        ],
        "answer": [
            "チーム全体の「IoTドメイン知識」の不足を補うため、業務知識のトレーニングを提供する、またはドメインエキスパートを採用する",
            "メンバWとXが実装スキルを持っているが、チーム全体としては自動化対応力が不足するリスクがあるため、実装（プログラミング）スキルのトレーニングをVとZに提供する"
        ]
    },

    # ---------------------------
    # 第2章 一般 Vol.23 (ch2_general_vol23.json)
    # ---------------------------
    "Q2-GEN-V23-01": { # 偽陽性・偽陰性
        "options": [
            "A:故障, B:偽陽性(False Positive), C:報告をためらう, D:偽陰性(False Negative / バグの見逃し)",
            "A:欠陥, B:偽陰性(False Negative), C:報告を乱発する, D:偽陽性(False Positive)",
            "A:故障, B:過検出(Overkill), C:楽観視する, D:テスト工数",
            "A:インシデント, B:仕様変更, C:無視する, D:手戻り"
        ],
        "answer": ["A:故障, B:偽陽性(False Positive), C:報告をためらう, D:偽陰性(False Negative / バグの見逃し)"]
    },

    # ---------------------------
    # 第3章 一般 Vol.25 (ch3_general_vol25.json)
    # ---------------------------
    "Q3-GEN-V25-01": { # 自動化ROI
        "options": [
            "自動化は毎月30万円（50万-20万）の工数削減効果しかなく、初期投資500万円の回収には約17ヶ月かかるため、短期的なコストメリットは薄いと報告する",
            "工数削減効果（月30万円）に加え、リリース後の致命的欠陥の抑止効果（月100万円のリスク回避）を含めると、月額130万円相当の価値を生んでおり、初期投資は約4ヶ月で回収できる計算になるため、非常に高いROIであると報告する",
            "ROIは金銭的価値（工数削減）のみで判断すべきであるため、品質リスクの低減効果（非金銭的価値）は報告から除外する",
            "コスト回収期間が長すぎるため、自動化の範囲を「画面キャプチャの取得」のみに限定し、保守コストを下げる（誤った最適化）"
        ],
        "answer": ["工数削減効果（月30万円）に加え、リリース後の致命的欠陥の抑止効果（月100万円のリスク回避）を含めると、月額130万円相当の価値を生んでおり、初期投資は約4ヶ月で回収できる計算になるため、非常に高いROIであると報告する"]
    },

    # ---------------------------
    # 第1章 一般 Vol.22 (ch1_general_vol22.json)
    # ---------------------------
    "Q1-GEN-V22-01": { # ワイドバンドデルファイ
        "options": [
            "平均をとって「11人日」で決定する",
            "最も経験のあるAさんの「5人日」を尊重し、議論なしで採用する",
            "最大値と最小値の差が大きいため、Cさんに「なぜ20人日と考えたか（リスク）」、Aさんに「なぜ5人日でできると考えたか（前提）」を説明してもらい、認識を合わせてから再投票を行う",
            "議論は時間がかかるため、中間の「8人日」を妥協案として採用し、会議を終了する"
        ],
        "answer": ["最大値と最小値の差が大きいため、Cさんに「なぜ20人日と考えたか（リスク）」、Aさんに「なぜ5人日でできると考えたか（前提）」を説明してもらい、認識を合わせてから再投票を行う"]
    },

    # ---------------------------
    # 第2章 一般 Vol.22 (ch2_general_vol22.json)
    # ---------------------------
    "Q2-GEN-V22-01": { # 静的解析運用
        "options": [
            "「誤検知も含めて全て修正せよ」と命令し、修正完了までビルドをブロックする（開発速度の低下）",
            "ツールのルールセットをチューニングし、プロジェクトの文脈に合わないルールを無効化する。また、どうしても発生する誤検知にはコード内で「抑制コメント（Suppress Warning）」を付ける運用ルールを定め、警告数ゼロを目指せる状態にする",
            "警告を無視してビルドを通すために、CIパイプラインの静的解析ステップを一時的に無効化する",
            "警告レベルを全て「情報（Info）」に下げ、開発者の目に触れないようにする"
        ],
        "answer": ["ツールのルールセットをチューニングし、プロジェクトの文脈に合わないルールを無効化する。また、どうしても発生する誤検知にはコード内で「抑制コメント（Suppress Warning）」を付ける運用ルールを定め、警告数ゼロを目指せる状態にする"]
    },

    # ---------------------------
    # 第2章 医療 Vol.22 (ch2_medical_vol22.json)
    # ---------------------------
    "Q2-MED-V22-01": { # SOUPリスク管理
        "options": [
            "SOUPの品質保証は開発元の責任であるため、受入テスト（UAT）のみを行い、内部構造のリスク分析は省略する",
            "SOUPとしてのリスク分析を行い、既知のバグや脆弱性を調査する。さらに、SOUPが異常動作（クラッシュ等）した場合でも、医療機器本体が安全側（フェイルセーフ）に倒れるようなアーキテクチャ設計を行い、それを検証する",
            "SOUPのソースコードが入手できないため、ホワイトボックステストは不可能と判断し、ブラックボックステストも省略する",
            "開発者が「動作確認済み」と報告しているため、追加の検証は不要とする"
        ],
        "answer": ["SOUPとしてのリスク分析を行い、既知のバグや脆弱性を調査する。さらに、SOUPが異常動作（クラッシュ等）した場合でも、医療機器本体が安全側（フェイルセーフ）に倒れるようなアーキテクチャ設計を行い、それを検証する"]
    },

    # ---------------------------
    # 第3章 一般 Vol.22 (ch3_general_vol22.json)
    # ---------------------------
    "Q3-GEN-V22-01": { # プロセス改善優先度
        "options": [
            "現場の負担を減らすため、プロセス変更を伴わない「ドキュメントの書式統一」のみを実施する（形式的改善）",
            "ビジネス目標（例：Time to Marketの短縮、高信頼性の確保）に最も貢献するキーエリアを特定し、そこを重点的に改善する",
            "現状の成熟度レベルを診断し、ボトルネックになっている（成熟度が低い）エリアを特定して、全体のレベルを底上げする",
            "他社で成功した事例をそのまま模倣し、自社の文脈を無視して導入する"
        ],
        "answer": [
            "ビジネス目標（例：Time to Marketの短縮、高信頼性の確保）に最も貢献するキーエリアを特定し、そこを重点的に改善する",
            "現状の成熟度レベルを診断し、ボトルネックになっている（成熟度が低い）エリアを特定して、全体のレベルを底上げする"
        ]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第21弾：最終調整を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()