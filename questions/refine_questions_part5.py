import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第5弾）
# ==========================================
fixes = {
    # ---------------------------
    # 第2章 一般 Vol.3 (ch2_general_vol3.json)
    # ---------------------------
    "Q2-GEN-V3-01": { # パースペクティブベースドリーディング
        "options": [
            "参加者が「ユーザー」「保守担当」「テスター」などの異なる視点（役割）になりきって欠陥を探す",
            "作成されたドキュメントを、チェックリストの上から順に機械的に確認し、抜け漏れがないか検証する",
            "シナリオベースのレビューとは異なり、アドホックに思いついた箇所をランダムにチェックする",
            "誤字脱字や表記ゆれなどの形式的な問題を、ツールを使って自動的に検出する"
        ],
        "answer": ["参加者が「ユーザー」「保守担当」「テスター」などの異なる視点（役割）になりきって欠陥を探す"]
    },
    "Q2-GEN-V3-03": { # パレートの法則（バグ集中）
        "options": [
            "そのモジュールを重点的にリファクタリング（設計見直し）し、構造的な弱点を改善する",
            "そのモジュールの開発担当者を即座に交代させ、過去のコードを全て破棄して作り直させる",
            "そのモジュールに対して追加の単体テストとコードレビューを実施し、検証密度を高める",
            "そのモジュールはバグが出尽くしたと判断し、これ以上のテスト工数をかけずにリリースする"
        ],
        "answer": [
            "そのモジュールを重点的にリファクタリング（設計見直し）し、構造的な弱点を改善する",
            "そのモジュールに対して追加の単体テストとコードレビューを実施し、検証密度を高める"
        ]
    },

    # ---------------------------
    # 第3章 AWS Vol.3 (ch3_aws_vol3.json)
    # ---------------------------
    "Q3-AWS-V3-01": { # コスト意識啓蒙
        "options": [
            "管理者が独断でコストの高いインスタンスを特定し、予告なく停止・削除して強制的にコストを下げる",
            "AWS Budgetsのアラートをチームチャットに通知し、全員がコスト状況をリアルタイムに見えるようにする",
            "コスト情報は経営層のみが知るべき機密事項として扱い、開発チームには一切開示しない",
            "AWSの利用を原則禁止し、承認された場合のみオンプレミス環境からリソースを払い出す運用に戻す"
        ],
        "answer": ["AWS Budgetsのアラートをチームチャットに通知し、全員がコスト状況をリアルタイムに見えるようにする"]
    },

    # ---------------------------
    # 第1章 AWS Vol.3 (ch1_aws_vol3.json)
    # ---------------------------
    "Q1-AWS-V3-01": { # 夜間停止とテスト計画
        "options": [
            "夜間バッチテストができなくなるため、日中に移行するか、必要なインスタンスのみ夜間起動するタグ付け運用を行う",
            "テスト期間中はコスト最適化よりも進捗を優先すべきとし、すべての環境を24時間稼働させ続ける",
            "テスト環境を毎晩完全に削除（Terminate）し、翌朝ゼロから構築し直す（データ永続性は考慮しない）",
            "開発者およびテスト担当者に夜間の勤務を禁止し、システムの稼働時間に合わせて業務時間を変更させる"
        ],
        "answer": ["夜間バッチテストができなくなるため、日中に移行するか、必要なインスタンスのみ夜間起動するタグ付け運用を行う"]
    },

    # ---------------------------
    # 第1章 金融 Vol.3 (ch1_finance_vol3.json)
    # ---------------------------
    "Q1-FIN-V3-01": { # ATM現金取り忘れテスト
        "options": [
            "本番稼働中の実機を使用し、銀行から借り受けた本物の現金を使ってリアリティのあるテストを行う",
            "テストモードを備えた実機またはシミュレーターを使用し、本物の現金は使わずテスト用媒体（テスト券）を使う",
            "現金検知センサーの仕様書のみを確認し、実機での物理的なテストは省略する（机上検証のみ）",
            "ATMの筐体を分解し、センサー部分を手動で遮断することで、紙幣がある状態を擬似的に作り出す"
        ],
        "answer": ["テストモードを備えた実機またはシミュレーターを使用し、本物の現金は使わずテスト用媒体（テスト券）を使う"]
    },

    # ---------------------------
    # 第1章 一般 Vol.3 (ch1_general_vol3.json)
    # ---------------------------
    "Q1-GEN-V3-01": { # Sカーブ停滞
        "options": [
            "バグが無限に見つかっており、開発チームの修正が追いついていない（発散状態）",
            "テスト実行が止まっているか、あるいはバグの発見率が飽和し、品質が安定しつつある（収束状態）",
            "開発者が意図的にバグを隠蔽しており、テスト担当者に報告させないようにしている",
            "テスト管理ツールの集計ロジックに誤りがあり、正しいデータが反映されていない"
        ],
        "answer": ["テスト実行が止まっているか、あるいはバグの発見率が飽和し、品質が安定しつつある（収束状態）"]
    },
    "Q1-GEN-V3-04": { # 分散開発のリスク
        "options": [
            "時差、言語、文化の違いによるコミュニケーションのオーバーヘッドと、要件認識の祖語",
            "開発用PCのスペック不足により、ビルドやテスト実行に時間がかかる技術的リスク",
            "現地スタッフのランチ代や交通費などの経費が、当初の予算を上回る財務的リスク",
            "現地の祝日や休暇制度の違いにより、日本のカレンダー通りに業務が進まないスケジュールリスク"
        ],
        "answer": ["時差、言語、文化の違いによるコミュニケーションのオーバーヘッドと、要件認識の祖語"]
    },
    "Q1-GEN-V3-05": { # 探索的テストの説得
        "options": [
            "セッションベースドテスト管理（SBTM）を導入し、チャーター（目的）とタイムボックス（時間枠）で活動を定量化する",
            "探索的テストは熟練者の勘に頼るものであり、管理や定量化は不可能であると主張し、信頼を求める",
            "探索的テストを実施した後で、実施した内容に合わせてテストケースを作成し、計画的テストに見せかける",
            "管理層の理解が得られるまで探索的テストの導入を諦め、すべて記述式テスト（スクリプトテスト）のみを行う"
        ],
        "answer": ["セッションベースドテスト管理（SBTM）を導入し、チャーター（目的）とタイムボックス（時間枠）で活動を定量化する"]
    },

    # ---------------------------
    # 第2章 クラウド Vol.3 (ch2_cloud_vol3.json)
    # ---------------------------
    "Q2-CLD-V3-01": { # 分散トレーシング
        "options": [
            "各マイクロサービスのログを単一のファイルに集約し、grep検索でエラーを見つける",
            "マイクロサービス間を跨るリクエストの経路とレイテンシを可視化し、分散システムのボトルネックを特定する",
            "データベースのクエリログを解析し、スロークエリを自動的にチューニングする",
            "ネットワークパケットをキャプチャし、不正な侵入の痕跡がないかを監査する"
        ],
        "answer": ["マイクロサービス間を跨るリクエストの経路とレイテンシを可視化し、分散システムのボトルネックを特定する"]
    },
    "Q2-CLD-V3-02": { # イミュータブルインフラ
        "options": [
            "稼働中のサーバーにSSHでログインし、パッケージマネージャ（yum/apt）でパッチを適用する",
            "新しいバージョンのサーバーイメージを作成し、稼働中のものと丸ごと入れ替える（Blue/Greenデプロイ等）",
            "セキュリティパッチはアプリケーションの動作に影響を与える可能性があるため、原則として適用しない",
            "サーバーを再起動することで、メモリ上の不整合をリセットし、一時的に状態をクリーンにする"
        ],
        "answer": ["新しいバージョンのサーバーイメージを作成し、稼働中のものと丸ごと入れ替える（Blue/Greenデプロイ等）"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第5弾：問題データの修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()