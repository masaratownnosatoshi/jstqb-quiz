import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第22弾・Vol.26-28 最終調整）
# ==========================================
fixes = {
    # ---------------------------
    # 第3章 一般 Vol.28 (ch3_general_vol28.json)
    # ---------------------------
    "Q3-GEN-V28-01": { # 環境構築トラブル
        "options": [
            "「テスト実行」の担当者を増員し、人海戦術で環境構築の遅れを取り戻そうとする（ボトルネックの読み違え）",
            "テスト環境構築は「インフラ知識」や「トラブルシューティング能力」が必要な高度なタスクであると認識し、専任のテクニカルテストアナリスト（TTA）を配置するか、インフラ担当者によるOJT/ペア作業を導入してスキル移転を図る",
            "手順書の不備が原因と断定し、担当者に手順書の書き直しを命じる（根本解決にならない）",
            "環境構築は開発チームの責任であるとして、テストチームは関与を拒否する（サイロ化）"
        ],
        "answer": ["テスト環境構築は「インフラ知識」や「トラブルシューティング能力」が必要な高度なタスクであると認識し、専任のテクニカルテストアナリスト（TTA）を配置するか、インフラ担当者によるOJT/ペア作業を導入してスキル移転を図る"]
    },

    # ---------------------------
    # 第2章 金融 Vol.26 (ch2_finance_vol26.json)
    # ---------------------------
    "Q2-FIN-V26-01": { # セキュリティ要件の曖昧さ
        "options": [
            "「可能な限り安全にする」という記述を残し、実装担当者の裁量に任せる（丸投げ）",
            "「OWASP Top 10の脆弱性に対応し、かつFISC安全対策基準の第X項に準拠すること。また、ログイン試行回数が5回を超えた場合はアカウントをロックすること」と具体的に定義する",
            "「セキュリティ詳細設計は実装フェーズで行う」として、要件定義書からは削除する（手戻りリスクの増大）",
            "セキュリティは非機能要件なので、インフラ担当者に一任する"
        ],
        "answer": ["「OWASP Top 10の脆弱性に対応し、かつFISC安全対策基準の第X項に準拠すること。また、ログイン試行回数が5回を超えた場合はアカウントをロックすること」と具体的に定義する"]
    },

    # ---------------------------
    # 第2章 医療 Vol.26 (ch2_medical_vol26.json)
    # ---------------------------
    "Q2-MED-V26-01": { # 1行変更の判断
        "options": [
            "開発者の「影響なし」という言葉を信じて、テストなしで承認する",
            "変更の影響範囲分析（Impact Analysis）を正式に行い、その結果に基づいて回帰テストの範囲を決定する。たとえ1行でも、クリティカルな機能に影響する可能性がある場合は、システム全体の回帰テストが必要になることもある",
            "全テストをやり直すのはコスト高なので、影響がありそうな画面の目視確認のみで済ませる",
            "「緊急修正（Hotfix）」として扱い、正規の変更管理プロセス（CCB承認等）を省略してリリースし、事後報告とする（規制違反リスク）"
        ],
        "answer": ["変更の影響範囲分析（Impact Analysis）を正式に行い、その結果に基づいて回帰テストの範囲を決定する。たとえ1行でも、クリティカルな機能に影響する可能性がある場合は、システム全体の回帰テストが必要になることもある"]
    },

    # ---------------------------
    # 第2章 金融 Vol.27 (ch2_finance_vol27.json)
    # ---------------------------
    "Q2-FIN-V27-01": { # COQによる提案
        "options": [
            "「品質はプライスレスだ」と精神論で訴え、コスト対効果の説明を避ける",
            "「外部失敗コストが1,000万円と突出して高い。これは欠陥が後工程まで流出したことが原因である。上流でのレビュー（評価コスト）に100万円追加投資することで、手戻り（内部失敗）と市場障害（外部失敗）を50%削減できれば、トータルで550万円のコスト削減（ROI）が見込める」と数値で示す",
            "「競合他社A銀行もレビューを強化している」という事例のみを根拠とし、自プロジェクトのデータに基づかない提案をする",
            "「レビューをしないとバグが出る」と脅す"
        ],
        "answer": ["「外部失敗コストが1,000万円と突出して高い。これは欠陥が後工程まで流出したことが原因である。上流でのレビュー（評価コスト）に100万円追加投資することで、手戻り（内部失敗）と市場障害（外部失敗）を50%削減できれば、トータルで550万円のコスト削減（ROI）が見込める」と数値で示す"]
    },

    # ---------------------------
    # 第3章 一般 Vol.27 (ch3_general_vol27.json)
    # ---------------------------
    "Q3-GEN-V27-01": { # スキル不足対策
        "options": [
            "全員に高度な研修を受けさせ、全員がフルスタックエンジニアになることを目指す（非現実的）",
            "Bさん（自動化強）を「テクニカルテストアナリスト」として自動化基盤の構築と維持に専念させ、Cさん（コミュ強）を「テストコーディネータ」として他部署調整や設計レビューのまとめ役に配置する（適材適所）",
            "Aさん（リーダー）が全てのタスクを兼務し、他のメンバーはAさんの指示通りに動くマイクロマネジメント体制にする（バス係数リスク）",
            "スキルの低いDさんをプロジェクトから外し、少人数精鋭にする（リソース不足）"
        ],
        "answer": ["Bさん（自動化強）を「テクニカルテストアナリスト」として自動化基盤の構築と維持に専念させ、Cさん（コミュ強）を「テストコーディネータ」として他部署調整や設計レビューのまとめ役に配置する（適材適所）"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第22弾：Vol.26-28 問題修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()