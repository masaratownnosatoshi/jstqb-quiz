import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第14弾・Vol.10 K4シナリオ編）
# ==========================================
fixes = {
    # ---------------------------
    # 第1章 金融 Vol.10 (ch1_finance_vol10.json)
    # ---------------------------
    "Q1-FIN-V10-01": { # 性能テストNG時の判断
        "options": [
            "DBのCPUが100%でも、システムが落ちなければ許容範囲としてリリースする",
            "「流量制御（スロットリング）」機能を導入し、システム許容量を超えるアクセスを入り口で遮断（Wait画面表示等）して、システムダウンだけは防ぐ運用回避策を実装する",
            "リリースを3ヶ月延期し、データベースのスキーマを根本から再設計する（ビジネス影響無視）",
            "開発者に対し、具体的な根拠なしに「コードをもっと速くしろ」とチューニングを命じる"
        ],
        "answer": ["「流量制御（スロットリング）」機能を導入し、システム許容量を超えるアクセスを入り口で遮断（Wait画面表示等）して、システムダウンだけは防ぐ運用回避策を実装する"]
    },

    # ---------------------------
    # 第1章 一般 Vol.10 (ch1_general_vol10.json)
    # ---------------------------
    "Q1-GEN-V10-01": { # バグ収束しない場合
        "options": [
            "納期を守ることを最優先し、残っているバグは「運用で回避可能」とみなしてリリースを強行する",
            "潜在的なバグがまだ大量に残っている可能性が高いため、追加の探索的テストを実施し、リリースの延期基準に抵触しないか再評価する",
            "テスト終了基準を満たすために、発見されたバグの重要度を「高」から「中」や「低」に書き換える（ゲーミング）",
            "バグ発見率が高止まりしているのはテスターのスキルが高すぎるせいだと判断し、要員を減らす"
        ],
        "answer": ["潜在的なバグがまだ大量に残っている可能性が高いため、追加の探索的テストを実施し、リリースの延期基準に抵触しないか再評価する"]
    },
    "Q1-GEN-V10-02": { # Flaky Test対策
        "options": [
            "失敗したテストは「運が悪かった」とみなし、自動的に再実行して成功すればOKとする（リトライ依存）",
            "非同期処理の待機（Wait）設定を見直し、固定時間待機ではなく、要素の出現を待つ動的な待機（Explicit Wait）に変更する",
            "テスト環境のデータが実行ごとにクリーンアップされていない可能性があるため、データセットアップ/ティアダウンの処理を独立させる",
            "不安定なテストはメンテナンスコスト高となるため、原因調査をせずにテストスイートから削除する"
        ],
        "answer": [
            "非同期処理の待機（Wait）設定を見直し、固定時間待機ではなく、要素の出現を待つ動的な待機（Explicit Wait）に変更する",
            "テスト環境のデータが実行ごとにクリーンアップされていない可能性があるため、データセットアップ/ティアダウンの処理を独立させる"
        ]
    },

    # ---------------------------
    # 第2章 医療 Vol.10 (ch2_medical_vol10.json)
    # ---------------------------
    "Q2-MED-V10-01": { # 軽微変更のリスク分析
        "options": [
            "フォントサイズの変更のみであるため、開発者の目視確認だけで済ませ、テスト記録は作成しない",
            "影響分析（Impact Analysis）に基づき、数値表示に関わる全ての画面の表示テストと、誤読リスクに対するユーザビリティテストを実施する",
            "変更の影響範囲に関わらず、念のためシステムの全機能を最初からテストし直す（非効率な全リグレッション）",
            "OSのレンダリングエンジンに依存するため、テストは不可能と判断する"
        ],
        "answer": ["影響分析（Impact Analysis）に基づき、数値表示に関わる全ての画面の表示テストと、誤読リスクに対するユーザビリティテストを実施する"]
    },

    # ---------------------------
    # 第3章 AWS Vol.10 (ch3_aws_vol10.json)
    # ---------------------------
    "Q3-AWS-V10-01": { # CCoEガバナンス
        "options": [
            "各チームからAWS操作権限を剥奪し、すべてのリソース作成依頼をCCoEが手動で代行・承認する（ボトルネック化）",
            "AWS ConfigやSCP（Service Control Policies）を用いて、セキュリティ違反（例：S3公開）を自動検知・修復する「ガードレール」を構築し、ルール内での自由を与える",
            "開発者に「セキュリティルールを守ります」という誓約書を書かせ、技術的な制限は一切かけない",
            "ガバナンスを諦め、各チームに管理者権限（AdministratorAccess）を無条件で付与する"
        ],
        "answer": ["AWS ConfigやSCP（Service Control Policies）を用いて、セキュリティ違反（例：S3公開）を自動検知・修復する「ガードレール」を構築し、ルール内での自由を与える"]
    },

    # ---------------------------
    # 第3章 クラウド Vol.10 (ch3_cloud_vol10.json)
    # ---------------------------
    "Q3-CLD-V10-01": { # SREトイル過多
        "options": [
            "SREチームとは別に、アラート対応のみを行う「運用オペレーター部隊」を新設し、問題を右から左へ流す",
            "アラート通知の閾値を極端に緩めて通知数を減らし、問題を検知しないようにする",
            "「アラート対応はサービス開発チームの責任」という原則を再適用し、SREはプラットフォーム提供とコンサルティングに集中する体制へ移行する",
            "SREメンバーに24時間365日のシフト勤務を強制し、体力でカバーする"
        ],
        "answer": ["「アラート対応はサービス開発チームの責任」という原則を再適用し、SREはプラットフォーム提供とコンサルティングに集中する体制へ移行する"]
    },

    # ---------------------------
    # 第3章 一般 Vol.10 (ch3_general_vol10.json)
    # ---------------------------
    "Q3-GEN-V10-01": { # 離職対策
        "options": [
            "一時的な「引き留めボーナス」を支給するが、業務内容やキャリアパスの改善は行わない（衛生要因のみの対処）",
            "テスト自動化を推進して単純作業を減らし、浮いた時間で「テストアーキテクト」や「QAコンサルタント」等の高度な役割へのステップアップパスを提示・教育する",
            "採用基準を下げ、単純作業でも不満を持たないスキルレベルの人材に入れ替える",
            "就業規則で「退職は3ヶ月前に申し出ること」と厳格化し、法的圧力で引き留める"
        ],
        "answer": ["テスト自動化を推進して単純作業を減らし、浮いた時間で「テストアーキテクト」や「QAコンサルタント」等の高度な役割へのステップアップパスを提示・教育する"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第14弾：K4シナリオ問題の修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()