import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第7弾）
# ==========================================
fixes = {
    # ---------------------------
    # 第3章 医療 Vol.53 (ch3_medical_vol53.json)
    # ---------------------------
    "Q3-MED-V53-01": { # ログのバックデート問題
        "options": [
            "記憶を頼りに、過去の日付と署名を追記する（バックデート）",
            "ログ不備は「実施していない」のと同じ（証拠能力なし）と判断し、直ちに該当テストを「再実行」して、正しい日付と署名入りの正規ログを新たに作成する。監査では「記録不備により再実施した」事実を正直に説明する",
            "テスト自体は合格しているため、ログの不備については「記録ミス」として備考欄に注記し、そのまま提出する",
            "当時のテスト実施現場にいた別のメンバーに証言させ、その証言書をもって署名の代わりとする"
        ],
        "answer": ["ログ不備は「実施していない」のと同じ（証拠能力なし）と判断し、直ちに該当テストを「再実行」して、正しい日付と署名入りの正規ログを新たに作成する。監査では「記録不備により再実施した」事実を正直に説明する"]
    },

    # ---------------------------
    # 第1章 AWS Vol.5 (ch1_aws_vol5.json)
    # ---------------------------
    "Q1-AWS-V5-01": { # スポットインスタンスのリスク
        "options": [
            "インスタンスのスペックが保証されず、テスト実行速度が著しく低下する可能性がある",
            "突然中断される可能性があるため、ステートレスなテストや中断再開可能なバッチテストに利用する",
            "セキュリティグループの設定が適用されず、外部からのアクセスに対して脆弱になる",
            "AWSのメンテナンスウィンドウ中は強制的に再起動され、データがロールバックされる"
        ],
        "answer": ["突然中断される可能性があるため、ステートレスなテストや中断再開可能なバッチテストに利用する"]
    },
    "Q1-AWS-V5-02": { # リホスト（Rehost）戦略
        "options": [
            "アプリケーションアーキテクチャをマイクロサービスに刷新し、個別の機能ごとにテストを行う",
            "アプリを変更せず、インフラだけAWSに移設するため、既存機能の回帰テスト（動作互換性）を最優先する",
            "サーバーレス（Lambda）への移行を前提とし、コールドスタート対策のパフォーマンステストを行う",
            "SaaS製品への乗り換えを行い、データの移行（マイグレーション）テストのみに注力する"
        ],
        "answer": ["アプリを変更せず、インフラだけAWSに移設するため、既存機能の回帰テスト（動作互換性）を最優先する"]
    },
    "Q1-AWS-V5-03": { # Lambda単体テスト（外部依存）
        "options": [
            "統合テスト環境のDynamoDBに直接接続し、データの整合性を厳密に検証する",
            "モック（Mock）やスタブを使用して外部依存を切り離し、ロジックのみを高速にテストする",
            "ローカル環境にDynamoDB Localを立ち上げ、本番と同じレイテンシをシミュレーションする",
            "AWS SAMを使用して、実際のクラウド環境にデプロイしてから単体テストを実行する"
        ],
        "answer": ["モック（Mock）やスタブを使用して外部依存を切り離し、ロジックのみを高速にテストする"]
    },

    # ---------------------------
    # 第1章 金融 Vol.4 (ch1_finance_vol4.json)
    # ---------------------------
    "Q1-FIN-V4-01": { # 証券システムの完全性
        "options": [
            "株価情報の更新ラグが1ミリ秒以内であり、他社サイトよりも高速であること（効率性）",
            "注文データが欠損・重複・改ざんされずに正しく約定・保存されること",
            "画面の配色がユニバーサルデザインに配慮されており、誤発注を防げること（使用性）",
            "システム障害時に、バックアップサイトへ1分以内に切り替わること（回復性）"
        ],
        "answer": ["注文データが欠損・重複・改ざんされずに正しく約定・保存されること"]
    },
    "Q1-FIN-V4-02": { # テストデータの不適切な扱い
        "options": [
            "本番データをマスキング（匿名化）し、個人を特定できない状態でテスト環境にロードする",
            "本番データをそのままコピーし、外部の協力会社のPCに保存してテストする",
            "本番データの統計情報に基づき、テストデータ生成ツールを使って合成データを作成する",
            "本番データは使用せず、ユースケースに基づいたシナリオデータを手動で作成する"
        ],
        "answer": ["本番データをそのままコピーし、外部の協力会社のPCに保存してテストする"]
    },

    # ---------------------------
    # 第1章 一般 Vol.4 (ch1_general_vol4.json)
    # ---------------------------
    "Q1-GEN-V4-01": { # エラーの定義
        "options": [
            "ソフトウェアに含まれる欠陥（バグ）そのもの",
            "人間の行為によって生じる誤り（ミステイク）",
            "システムが実行中に期待通りの動作をしないこと（故障）",
            "テストケースの手順に誤りがあること"
        ],
        "answer": ["人間の行為によって生じる誤り（ミステイク）"]
    },
    "Q1-GEN-V4-03": { # デバッグとテストの違い
        "options": [
            "テストは開発者が行い、デバッグはテスト担当者が行う",
            "テストは欠陥による故障を示す活動であり、デバッグは故障の原因を見つけて修正する活動である",
            "テストは品質を保証する活動であり、デバッグは品質を向上させる活動である",
            "テストは自動化できるが、デバッグは常に手動で行う必要がある"
        ],
        "answer": ["テストは欠陥による故障を示す活動であり、デバッグは故障の原因を見つけて修正する活動である"]
    },
    "Q1-GEN-V4-04": { # テストオラクル
        "options": [
            "テスト実行を自動化するためのスクリプトやツール",
            "期待結果を導き出すための情報源（仕様書、旧システム、経験則など）",
            "テスト対象のソフトウェアが稼働するデータベースサーバー",
            "テスト工程全体を管理するプロジェクトマネージャー"
        ],
        "answer": ["期待結果を導き出すための情報源（仕様書、旧システム、経験則など）"]
    },
    "Q1-GEN-V4-05": { # テストベース
        "options": [
            "テストを実行するためのハードウェアおよびネットワーク環境（テストベッド）",
            "テスト分析や設計の根拠となる全てのドキュメント（要件定義書、設計書など）",
            "テストケースを作成するためのテンプレートファイル",
            "テストチームが拠点とするメインオフィス"
        ],
        "answer": ["テスト分析や設計の根拠となる全てのドキュメント（要件定義書、設計書など）"]
    },
    "Q1-GEN-V4-06": { # 終了基準（不適切）
        "options": [
            "計画されたテストケースの100%実行と、重要度「中」以上の残存バグ0件",
            "コードカバレッジ（C1）が85%以上に達していること",
            "開発マネージャが「もう大丈夫だ」と感覚的に判断した時",
            "残存リスクがステークホルダーの許容レベル以下になったこと"
        ],
        "answer": ["開発マネージャが「もう大丈夫だ」と感覚的に判断した時"]
    },
    "Q1-GEN-V4-08": { # 負荷テスト失敗時の判断
        "options": [
            "リリースの延期を提案し、抜本的な性能改善を行う",
            "「運用でカバーする（入場制限や機能制限）」という暫定回避策を検討し、ステークホルダーと合意する",
            "「本番ではなんとかなるだろう」と楽観視し、リスクを報告せずに予定通りリリースする",
            "サーバーのスペックを一時的に増強（スケールアップ）し、急場をしのげるか再検証する"
        ],
        "answer": ["「本番ではなんとかなるだろう」と楽観視し、リスクを報告せずに予定通りリリースする"]
    },

    # ---------------------------
    # 第2章 クラウド Vol.4 (ch2_cloud_vol4.json)
    # ---------------------------
    "Q2-CLD-V4-01": { # 可用性の定義
        "options": [
            "必要な時にシステムが稼働しており、利用可能であること",
            "システムが高い負荷に耐え、応答時間を維持できること（性能効率性）",
            "システムが不正なアクセスから保護されていること（セキュリティ）",
            "システムが異なる環境でも動作すること（移植性）"
        ],
        "answer": ["必要な時にシステムが稼働しており、利用可能であること"]
    },
    "Q2-CLD-V4-02": { # マイクロサービスの特性（不適切）
        "options": [
            "疎結合性（各サービスがAPIを通じて通信し、独立していること）",
            "耐障害性（一部のサービスが停止しても、システム全体は稼働し続けること）",
            "モノリシックな巨大な実行ファイルとしてデプロイされること",
            "各サービスが独自のデータベースを持ち、データを分散管理すること"
        ],
        "answer": ["モノリシックな巨大な実行ファイルとしてデプロイされること"]
    },

    # ---------------------------
    # 第2章 一般 Vol.4 (ch2_general_vol4.json)
    # ---------------------------
    "Q2-GEN-V4-01": { # 機能性の定義
        "options": [
            "システムが何をするか（What）：明示的・暗黙的なニーズを満たす機能",
            "システムがどう動くか（How）：応答速度やリソース使用量",
            "システムがいかに使いやすいか：ユーザーインターフェースの直感性",
            "システムがいかに安全か：情報の機密性と完全性"
        ],
        "answer": ["システムが何をするか（What）：明示的・暗黙的なニーズを満たす機能"]
    },
    "Q2-GEN-V4-04": { # コードレビュー（不適切）
        "options": [
            "チェックリストを用いて、コーディング規約違反や論理エラーを探す",
            "作成者の人格やスキル不足を攻撃し、やる気を削ぐようなコメントを書く",
            "可読性や保守性の観点から、より良い実装方法を提案する",
            "静的解析ツールで検出された警告が修正されているか確認する"
        ],
        "answer": ["作成者の人格やスキル不足を攻撃し、やる気を削ぐようなコメントを書く"]
    },
    "Q2-GEN-V4-05": { # 欠陥密度
        "options": [
            "発見された欠陥数 ÷ テストにかかった総工数（人月）",
            "発見された欠陥数 ÷ プロダクトの規模（KLOCやFPなど）",
            "修正された欠陥数 ÷ 発見された全欠陥数（修正率）",
            "テストケースの消化数 ÷ 予定されていたテストケース総数（進捗率）"
        ],
        "answer": ["発見された欠陥数 ÷ プロダクトの規模（KLOCやFPなど）"]
    },
    "Q2-GEN-V4-06": { # Web互換性
        "options": [
            "異なるブラウザ（Chrome, Safari等）やOS、画面解像度での表示崩れや動作",
            "サーバー側のデータベース製品（MySQL, PostgreSQL等）の違いによるSQLの互換性",
            "開発環境と本番環境のミドルウェアバージョンの差異",
            "使用しているWebフレームワーク（React, Vue等）のバージョン間の互換性"
        ],
        "answer": ["異なるブラウザ（Chrome, Safari等）やOS、画面解像度での表示崩れや動作"]
    },

    # ---------------------------
    # 第3章 一般 Vol.4 (ch3_general_vol4.json)
    # ---------------------------
    "Q3-GEN-V4-01": { # ソフトスキル
        "options": [
            "プログラミング言語やテストツールの操作に関する高度な技術的知識（ハードスキル）",
            "コミュニケーション、協調性、批判的思考などの人間関係や思考に関するスキル",
            "Officeソフトやチャットツールを使いこなす事務処理能力",
            "マニュアルに従って正確にテストを実行する几帳面さ"
        ],
        "answer": ["コミュニケーション、協調性、批判的思考などの人間関係や思考に関するスキル"]
    },
    "Q3-GEN-V4-02": { # モチベーション低下（不適切）
        "options": [
            "達成可能な目標を設定し、成長を実感させる",
            "良い仕事に対して、チーム全体の前で承認と称賛を与える",
            "常に開発者の下請け扱いをし、単純作業のみを強要し、意見を聞かない",
            "新しい技術やツールに触れる機会を提供し、スキルアップを支援する"
        ],
        "answer": ["常に開発者の下請け扱いをし、単純作業のみを強要し、意見を聞かない"]
    },
    "Q3-GEN-V4-04": { # T型人材
        "options": [
            "特定の専門分野（縦棒）を持ちつつ、隣接分野（横棒）へも知見を広げている人材",
            "広く浅くあらゆる分野を知っているが、特定の専門分野を持たない人材（ジェネラリスト）",
            "一つの専門分野のみを極め、他の分野には関心を持たない職人気質の人材（I型人材）",
            "マネジメントスキルのみに特化し、技術的な現場作業は行わない人材"
        ],
        "answer": ["特定の専門分野（縦棒）を持ちつつ、隣接分野（横棒）へも知見を広げている人材"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第7弾：問題データの修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()