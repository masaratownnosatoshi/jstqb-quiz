import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第2弾）
# ==========================================
fixes = {
    # ---------------------------
    # 第3章 AWS (ch3_aws.json)
    # ---------------------------
    "Q3-AWS-01": { # 知識不足への対策
        "options": [
            "AWSの操作権限をシニアエンジニアのみに限定し、経験の浅いメンバーはドキュメント作成に専念させる",
            "トレーニング受講の推奨と、経験者とのペアテスティングを実施してOJTでスキルを引き上げる",
            "開発プロセスからテスト工程を排除し、AWSのマネージドサービスによる自動チェックのみに依存する",
            "知識不足のメンバーをプロジェクトから外し、外部ベンダーにすべてのテスト設計を委託する"
        ],
        "answer": ["トレーニング受講の推奨と、経験者とのペアテスティングを実施してOJTでスキルを引き上げる"]
    },
    "Q3-AWS-03": { # 認定資格の目的
        "options": [
            "資格保有者数をマーケティング資料に掲載し、会社の技術力を対外的にアピールするためだけに行う",
            "共通言語（用語）の習得とアーキテクチャ理解を深め、開発者と対等に議論してテスト効率を高める",
            "AWS利用料の割引特典を受けるための必須条件として、チーム全員に取得を義務付ける",
            "資格取得を昇給の唯一の条件とし、個人の技術スキルよりもペーパーテストの点数を評価する"
        ],
        "answer": ["共通言語（用語）の習得とアーキテクチャ理解を深め、開発者と対等に議論してテスト効率を高める"]
    },
    "Q3-AWS-05": { # GameDay
        "options": [
            "本番環境で発生しうる障害シナリオをシミュレーションし、チームで協力して解決することで対応力を高める",
            "AWSの新機能を試すためのサンドボックス環境として利用し、個々人が自由に好きなサービスを触る",
            "他社との競争を通じてプログラミング速度を競い、最もコーディングが速いエンジニアを選出する",
            "日常業務のストレスを解消するためのレクリエーションとして、ゲーム感覚でAWSリソースを削除する"
        ],
        "answer": ["本番環境で発生しうる障害シナリオをシミュレーションし、チームで協力して解決することで対応力を高める"]
    },

    # ---------------------------
    # 第3章 クラウド (ch3_cloud.json)
    # ---------------------------
    "Q3-CLD-01": { # 時差対策
        "options": [
            "全員が同じ時間に働けるよう、深夜残業や早朝出勤を義務付けてリアルタイムな会議を増やす",
            "チケット管理システムに情報を集約して非同期コミュニケーションを確立し、自律的な作業を促す",
            "時差のある拠点間のやり取りを禁止し、それぞれの拠点で完全に独立したプロジェクトとして運営する",
            "チャットツールでの即時返信（5分以内）をルール化し、常にオンライン状態であることを監視する"
        ],
        "answer": ["チケット管理システムに情報を集約して非同期コミュニケーションを確立し、自律的な作業を促す"]
    },
    "Q3-CLD-03": { # アジャイルのドキュメント
        "options": [
            "変化の速いクラウド開発ではドキュメントは一切作成せず、ソースコードのみを正とする",
            "必要な情報（Just Enough）をWiki等で共有・継続的に更新し、重厚な静的ドキュメントへの依存を減らす",
            "ウォーターフォールと同様に詳細な仕様書を完備し、承認印が得られるまで実装を開始しない",
            "すべての会議の内容を逐語録として記録し、膨大なテキストデータをアーカイブすることに注力する"
        ],
        "answer": ["必要な情報（Just Enough）をWiki等で共有・継続的に更新し、重厚な静的ドキュメントへの依存を減らす"]
    },

    # ---------------------------
    # 第1章 金融 (ch1_finance.json)
    # ---------------------------
    "Q1-FIN-01": { # 銀行システム更改戦略
        "options": [
            "現行システムと新システムの並行稼働による現新比較テストを実施し、監査証跡を確実に確保する",
            "テスト工数を削減するため、過去の障害事例のみを確認し、正常系のテストは省略する",
            "新機能の開発にリソースを集中させ、既存機能の回帰テストはユーザーからの報告ベースで対応する",
            "すべてのテスト結果を口頭で報告し、ドキュメント作成時間を削減してリリース速度を優先する"
        ],
        "answer": ["現行システムと新システムの並行稼働による現新比較テストを実施し、監査証跡を確実に確保する"]
    },
    "Q1-FIN-05": { # PCI DSS
        "options": [
            "クレジットカード番号を含むデータベースのカラムを暗号化するだけで、他のセキュリティ対策は免除される",
            "ネットワークおよびアプリケーションに対して、定期的な脆弱性スキャンと年1回以上のペネトレーションテストを実施する",
            "社内のセキュリティ意識向上のためにポスターを掲示し、物理的な入退室管理のみを厳格化する",
            "カード情報の処理をすべて自社開発の独自システムで行い、外部の決済代行業者を一切利用しない"
        ],
        "answer": ["ネットワークおよびアプリケーションに対して、定期的な脆弱性スキャンと年1回以上のペネトレーションテストを実施する"]
    },

    # ---------------------------
    # 第2章 AWS (ch2_aws.json)
    # ---------------------------
    "Q2-AWS-01": { # 静的テスト対象
        "options": [
            "稼働中のEC2インスタンスのCPU温度やメモリ使用率などのハードウェアメトリクス",
            "CloudFormationやTerraformなどのIaC（Infrastructure as Code）テンプレートのコードレビュー",
            "データセンターの物理的な警備体制や入退室ログの目視確認",
            "AWSマネジメントコンソールの配色の見やすさやボタンの配置などのGUIデザイン"
        ],
        "answer": ["CloudFormationやTerraformなどのIaC（Infrastructure as Code）テンプレートのコードレビュー"]
    },
    "Q2-AWS-05": { # S3バケットポリシー欠陥
        "options": [
            "バケット内のオブジェクトに対して、インターネットからのパブリックアクセスが意図せず許可されている",
            "バケット名がAWSの命名規則には準拠しているが、プロジェクトの命名規則とは異なる",
            "データの耐久性を高めるために、バージョニング機能とクロスリージョンレプリケーションが有効化されている",
            "アクセスログの保存先として、別のS3バケットが指定されている（循環参照の回避）"
        ],
        "answer": ["バケット内のオブジェクトに対して、インターネットからのパブリックアクセスが意図せず許可されている"]
    },

    # ---------------------------
    # 第2章 金融 (ch2_finance.json)
    # ---------------------------
    "Q2-FIN-02": { # 帳票テスト
        "options": [
            "帳票のデザインが最新の流行的で、色彩豊かであること（美的観点）",
            "数値の正確性はもちろん、ATM等での紙詰まりを防ぐための印字位置ズレがないこと（正確性・運用性）",
            "使用する用紙の質感が高級であり、顧客に好印象を与えること",
            "印刷にかかる時間が極めて短く、プリンタのスペックを最大限に引き出せていること"
        ],
        "answer": ["数値の正確性はもちろん、ATM等での紙詰まりを防ぐための印字位置ズレがないこと（正確性・運用性）"]
    },
    "Q2-FIN-05": { # 一貫性 (Consistency)
        "options": [
            "すべての画面や帳票のデザイン、フォント、色が統一されており、ユーザーが違和感を感じないこと",
            "データベースのトランザクション前後で、データの整合性が保たれていること（例：送金元と送金先の合計額が一致する）",
            "開発チーム全体でコーディング規約が守られており、ソースコードの可読性が高いこと",
            "会議の開催時間や議事録のフォーマットが常に一定であり、運用ルールが遵守されていること"
        ],
        "answer": ["データベースのトランザクション前後で、データの整合性が保たれていること（例：送金元と送金先の合計額が一致する）"]
    },

    # ---------------------------
    # 第2章 一般 (ch2_general.json)
    # ---------------------------
    "Q2-GEN-01": { # 欠陥レポート
        "options": [
            "テスト担当者の主観的な感想や、開発者に対する個人的な苦情",
            "欠陥を再現させるための詳細な手順、環境情報、期待値と実際の動作の差異",
            "欠陥を発見した正確な時刻（ミリ秒単位）と、その時のオフィスの室温",
            "プロジェクトマネージャーへの謝罪文と、今後の再発防止策の提案"
        ],
        "answer": ["欠陥を再現させるための詳細な手順、環境情報、期待値と実際の動作の差異"]
    },
    "Q2-GEN-10": { # 予防コスト
        "options": [
            "テスト実行にかかる人件費やテスト環境の維持費（評価コスト）",
            "リリース後に発見された欠陥の修正対応や顧客への補償費用（失敗コスト）",
            "プロセス改善、トレーニング、欠陥を作らないための設計レビュー費用（予防コスト）",
            "バグ修正後の再テスト（確認テスト）や回帰テストにかかる費用"
        ],
        "answer": ["プロセス改善、トレーニング、欠陥を作らないための設計レビュー費用（予防コスト）"]
    },

    # ---------------------------
    # 第2章 医療 (ch2_medical.json)
    # ---------------------------
    "Q2-MED-01": { # プライバシーチェック
        "options": [
            "アプリケーションのログファイルに、患者の氏名や病歴などの個人情報（PII）がそのまま出力されていないか",
            "画面のボタンが角丸デザインになっており、ユーザーに優しい印象を与えているか",
            "データベースのテーブル名やカラム名が、医学的に正しい英語で命名されているか",
            "電子カルテの背景色が、目に優しい緑色または青色に設定されているか"
        ],
        "answer": ["アプリケーションのログファイルに、患者の氏名や病歴などの個人情報（PII）がそのまま出力されていないか"]
    },
    "Q2-MED-03": { # ペースメーカー品質
        "options": [
            "最新のスマートフォンとBluetooth接続できる機能の豊富さと拡張性",
            "生命維持に直結するため、いかなる状況でも停止しない信頼性と、誤作動しない安全性",
            "電池交換を自分で行えるような、筐体の開けやすさとメンテナンス性",
            "患者の好みに合わせて振動パターンをカスタマイズできる娯楽性"
        ],
        "answer": ["生命維持に直結するため、いかなる状況でも停止しない信頼性と、誤作動しない安全性"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第2弾：問題データの修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        # 自分のファイルやインデックスは除外
        if filename in ["index.json", "refine_questions.py", "refine_questions_part2.py"]:
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()