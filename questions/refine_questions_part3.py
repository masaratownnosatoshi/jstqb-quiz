import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第3弾）
# ==========================================
fixes = {
    # ---------------------------
    # 第1章 金融 Vol.2 (ch1_finance_vol2.json)
    # ---------------------------
    "Q1-FIN-V2-01": { # ATM使用性
        "options": [
            "最新のグラフィック技術を駆使した、芸術的で美しい画面デザイン（美的ユーザビリティ）",
            "高齢者や障害者を含む多様な利用者が、迷わず誤操作なく利用できること（アクセシビリティと誤操作防止）",
            "画面遷移のアニメーションを多用し、ユーザーを飽きさせないエンターテインメント性",
            "英語だけでなく、マイナーな言語も含めた50ヶ国語以上への即時翻訳機能"
        ],
        "answer": ["高齢者や障害者を含む多様な利用者が、迷わず誤操作なく利用できること（アクセシビリティと誤操作防止）"]
    },

    # ---------------------------
    # 第1章 AWS Vol.2 (ch1_aws_vol2.json)
    # ---------------------------
    "Q1-AWS-V2-02": { # 運用上の優秀性
        "options": [
            "インフラ構築に使用されたコード（IaC）の総行数と、コメントの網羅率",
            "デプロイ失敗時の回復手順（ロールバック）の確立や、小規模かつ可逆的な変更が可能であること",
            "マネジメントコンソールのGUIデザインが、運用担当者の好みに合っているか",
            "データセンターで使用されている物理サーバーの重量と、耐震構造の強度"
        ],
        "answer": ["デプロイ失敗時の回復手順（ロールバック）の確立や、小規模かつ可逆的な変更が可能であること"]
    },

    # ---------------------------
    # 第3章 金融 (ch3_finance.json)
    # ---------------------------
    "Q3-FIN-01": { # 独立性重視の理由
        "options": [
            "開発チームとの人間関係を希薄にし、馴れ合いによる甘えを防止するため",
            "監査上の利益相反を回避し、客観的な証拠能力（エビデンス）を担保するため",
            "テスト担当者の給与査定を開発部門とは別体系にし、人件費を抑制するため",
            "高価なテスト自動化ツールを導入する際、開発部門の決裁を通さずに済むようにするため"
        ],
        "answer": ["監査上の利益相反を回避し、客観的な証拠能力（エビデンス）を担保するため"]
    },
    "Q3-FIN-03": { # コンプライアンス意識
        "options": [
            "システム障害が発生した際、銀行の信用を守るために情報を外部に漏らさない（隠蔽する）こと",
            "顧客情報の保護と不正取引の防止を最優先し、たとえ納期が遅れてもセキュリティリスクを見過ごさないこと",
            "銀行の利益を最大化するため、テスト工数を極限まで削減し、コストカットに貢献すること",
            "定時退社を厳守し、ワークライフバランスを保つことで業務効率を上げること"
        ],
        "answer": ["顧客情報の保護と不正取引の防止を最優先し、たとえ納期が遅れてもセキュリティリスクを見過ごさないこと"]
    },
    "Q3-FIN-04": { # ベンダー丸投げ対策
        "options": [
            "契約内容に基づき、すべての品質責任はベンダーにあるとして、成果物をそのまま受け取る",
            "受け入れテスト（UAT）の主体は自行（発注者）であることを認識し、要件通りか自ら検証するプロセスを強化する",
            "納期遅延や品質不良が発生した場合、直ちに損害賠償請求を行い、ベンダー担当者を入れ替えさせる",
            "ベンダーとの契約を即座に解除し、すべてのシステム開発を内製化（インハウス）に切り替える"
        ],
        "answer": ["受け入れテスト（UAT）の主体は自行（発注者）であることを認識し、要件通りか自ら検証するプロセスを強化する"]
    },

    # ---------------------------
    # 第3章 一般 (ch3_general.json)
    # ---------------------------
    "Q3-GEN-05": { # テスターのソフトスキル
        "options": [
            "複雑なアルゴリズムを即座に実装できる高度なプログラミング能力",
            "前提を疑う批判的思考（クリティカルシンキング）と、対立を生まないコミュニケーション能力",
            "長時間のテスト実行にも耐えうる強靭な握力と体力",
            "休憩時間を惜しんで食事を済ませ、業務時間を最大化する早食いのスキル"
        ],
        "answer": ["前提を疑う批判的思考（クリティカルシンキング）と、対立を生まないコミュニケーション能力"]
    },
    "Q3-GEN-06": { # 採用方針（多様性）
        "options": [
            "コミュニケーションコストを下げるため、現メンバーと似た経歴・思考を持つ人を優先的に採用する",
            "「殺虫剤のパラドックス」を防ぐため、異なるドメイン知識や技術背景を持つ人を採用し、視点の多様性を確保する",
            "人件費予算を達成するため、経験の浅いジュニア層のみを大量に採用する",
            "信頼関係を早期に構築するため、経営陣や既存社員の知人・友人を優先的にリファラル採用する"
        ],
        "answer": ["「殺虫剤のパラドックス」を防ぐため、異なるドメイン知識や技術背景を持つ人を採用し、視点の多様性を確保する"]
    },
    "Q3-GEN-08": { # 開発とテストの対立
        "options": [
            "開発チームの意向を尊重し、指摘した欠陥を取り下げて円満な関係を維持するようテスターに指示する",
            "欠陥を作り込んだ開発者を厳しく叱責し、反省文を書かせることで品質意識を高めさせる",
            "「品質向上」という共通の目標を確認し、感情的な対立ではなく技術的な解決策を議論する場を設ける",
            "開発チームとテストチームの物理的な席を離し、接触を最小限にすることで衝突を回避する"
        ],
        "answer": ["「品質向上」という共通の目標を確認し、感情的な対立ではなく技術的な解決策を議論する場を設ける"]
    },
    "Q3-GEN-10": { # Whole Team Approach
        "options": [
            "テスト期間中は開発作業を停止し、開発者も含めた全員で手動テストの実装と実行を行うこと",
            "品質はテスト担当者だけでなく、開発者、POなどチーム全員の責任であるというマインドセットを持つこと",
            "チーム全員でペアプログラミングを行い、常に二人一組で開発を進めること",
            "スプリント終了後に全員で長期休暇を取り、リフレッシュして次の開発に備えること"
        ],
        "answer": ["品質はテスト担当者だけでなく、開発者、POなどチーム全員の責任であるというマインドセットを持つこと"]
    },

    # ---------------------------
    # 第3章 医療 (ch3_medical.json)
    # ---------------------------
    "Q3-MED-02": { # 医療テスターのスキル
        "options": [
            "最新のWebデザイントレンドや、配色の心理効果に関する知識",
            "医療機器規制（FDA/MDR等）や臨床ワークフローに関するドメイン知識",
            "高度なゲーミフィケーション理論を用いて、ユーザーを楽しませる知識",
            "SNSでのマーケティング手法や、インフルエンサーを活用した広報の知識"
        ],
        "answer": ["医療機器規制（FDA/MDR等）や臨床ワークフローに関するドメイン知識"]
    },
    "Q3-MED-04": { # 手順無視への対応
        "options": [
            "テスト結果自体は「合格」であるため、効率的な方法を発見したとして称賛し、不問にする",
            "医療機器開発では「正しい手順で実施した証拠」が必須であるため、プロセス遵守の重要性を指導し、再実施させる",
            "規則違反として直ちに解雇処分とし、他のメンバーへの見せしめにする",
            "ログの日付だけを修正し、手順書通りに実施したようにドキュメントを整える（つじつま合わせ）"
        ],
        "answer": ["医療機器開発では「正しい手順で実施した証拠」が必須であるため、プロセス遵守の重要性を指導し、再実施させる"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第3弾：問題データの修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        # スクリプトファイルなどは除外
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()