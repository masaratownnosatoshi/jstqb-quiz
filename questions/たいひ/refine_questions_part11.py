import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第11弾・Vol.7 & Vol.8）
# ==========================================
fixes = {
    # ---------------------------
    # 第1章 一般 Vol.8 (ch1_general_vol8.json)
    # ---------------------------
    "Q1-GEN-V8-01": { # ツール導入パイロット
        "options": [
            "ツールベンダーとの価格交渉を有利に進めるため、全社一括導入の契約を先に結ぶ",
            "組織全体に展開する前に、小規模な範囲でツールの適合性やプロセスへの影響を確認し、運用ルールを確立する",
            "ツールの機能（スペック）検証のみを行い、実際の業務プロセスとの適合性は考慮しない",
            "テスト担当者の空き時間を利用して、マニュアルを読ませるだけの学習期間とする"
        ],
        "answer": ["組織全体に展開する前に、小規模な範囲でツールの適合性やプロセスへの影響を確認し、運用ルールを確立する"]
    },

    # ---------------------------
    # 第1章 AWS Vol.8 (ch1_aws_vol8.json)
    # ---------------------------
    "Q1-AWS-V8-01": { # Device Farm
        "options": [
            "IoTデバイス（センサー等）のファームウェアをOTAアップデートするための配信基盤",
            "多数の実機デバイス（スマホ・タブレット）に対するモバイルアプリの自動テスト実行",
            "AWSのデータセンター内にある物理サーバーラックを専有してホスティングするサービス",
            "農業向けのエッジコンピューティング環境を提供するサービス"
        ],
        "answer": ["多数の実機デバイス（スマホ・タブレット）に対するモバイルアプリの自動テスト実行"]
    },

    # ---------------------------
    # 第2章 一般 Vol.7 (ch2_general_vol7.json)
    # ---------------------------
    "Q2-GEN-V7-01": { # 根本原因分析（仕様誤解）
        "options": [
            "テスト実行フェーズでのバグ検出数をKPIとし、テスターを増員して発見率を上げる（対処療法）",
            "開発者に対して、仕様書を読まずに実装するアジャイル手法（誤った解釈）を推奨する",
            "要件定義および設計フェーズにテスト担当者が参画し、仕様書のインスペクション（レビュー）を早期に行うシフトレフト施策を導入する",
            "バグ修正の担当者を固定し、特定の開発者に責任を集中させる"
        ],
        "answer": ["要件定義および設計フェーズにテスト担当者が参画し、仕様書のインスペクション（レビュー）を早期に行うシフトレフト施策を導入する"]
    },

    # ---------------------------
    # 第3章 クラウド Vol.7 (ch3_cloud_vol7.json)
    # ---------------------------
    "Q3-CLD-V7-01": { # SREアンチパターン
        "options": [
            "開発チームがインフラに触れないよう権限を剥奪し、SREチームだけがリリース作業を行えるようにする（サイロ化）",
            "「SREは運用代行屋ではなく、信頼性向上のためのプラットフォーム提供者である」という役割定義を明確にし、開発チームにオンコール対応（持ち回り）の一部を移譲する",
            "SREチームが開発チームの代わりに全てのアラート対応と障害復旧を行い、開発者がコード書きに専念できるようにする（パターナリズム）",
            "品質低下を受け入れ、エラーバジェットの目標値を極端に低く設定し直す"
        ],
        "answer": ["「SREは運用代行屋ではなく、信頼性向上のためのプラットフォーム提供者である」という役割定義を明確にし、開発チームにオンコール対応（持ち回り）の一部を移譲する"]
    },

    # ---------------------------
    # 第3章 一般 Vol.7 (ch3_general_vol7.json)
    # ---------------------------
    "Q3-GEN-V7-01": { # チーム形成（ストーミング）
        "options": [
            "対立を避けるため、表面的なルール（定例会の開催等）だけを決め、根本的な価値観の相違には触れない（Smoothing）",
            "対立（ストーミング）はチーム成長に必要なプロセスであると認識し、両者の価値観をぶつけ合わせるワークショップをファシリテートし、共通の「品質ゴール」を再定義させる",
            "マネージャがトップダウンで手順を強制し、チーム内の議論を封じる（Formingへの逆行）",
            "メンバーの相性が悪いと判断し、即座にチームを解散・再編する"
        ],
        "answer": ["対立（ストーミング）はチーム成長に必要なプロセスであると認識し、両者の価値観をぶつけ合わせるワークショップをファシリテートし、共通の「品質ゴール」を再定義させる"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第11弾：問題データの修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()