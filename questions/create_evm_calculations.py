import json
import os

OUTPUT_FILE = "ch_calculation_evm.json"

new_questions = [
  {
    "id": "Q-CALC-EVM-01",
    "chapter": "第2章",
    "level": "K3",
    "category": "モニタリング",
    "style": "計算",
    "type": "単一選択",
    "question": "【計算】EVMによるコスト効率（CPI）の評価。\nプロジェクト開始から3ヶ月時点でのデータは以下の通りであった。\n\n・PV（計画価値）：500万円\n・EV（出来高）：450万円\n・AC（実コスト）：500万円\n\nこのプロジェクトのコスト効率指標（CPI）と、予算に対する状態として正しいものはどれか。",
    "options": [
      "CPI = 0.9（予算超過）",
      "CPI = 1.0（予算通り）",
      "CPI = 1.1（予算内）",
      "CPI = 0.9（予算内）"
    ],
    "answer": [
      "CPI = 0.9（予算超過）"
    ],
    "explanation": "【解説】\nコスト効率指数 (CPI) = EV ÷ AC\n$$450 \\div 500 = 0.9$$\n\nCPIが 1.0 を下回っている場合は「コスト効率が悪い（投入したコストほど成果が出ていない）」ことを意味し、予算超過（赤字）傾向にあります。",
    "tags": ["計算", "EVM", "CPI"]
  },
  {
    "id": "Q-CALC-EVM-02",
    "chapter": "第2章",
    "level": "K3",
    "category": "モニタリング",
    "style": "計算",
    "type": "単一選択",
    "question": "【計算】スケジュール差異（SV）とコスト差異（CV）の算出。\n・PV（計画）：1000万円\n・EV（実績）：800万円\n・AC（コスト）：900万円\n\nこの時点でのスケジュール差異（SV）とコスト差異（CV）の組み合わせとして正しいものはどれか。",
    "options": [
      "SV = -200万円, CV = -100万円",
      "SV = +200万円, CV = +100万円",
      "SV = -100万円, CV = -200万円",
      "SV = -200万円, CV = +100万円"
    ],
    "answer": [
      "SV = -200万円, CV = -100万円"
    ],
    "explanation": "【解説】\n・スケジュール差異 (SV) = EV - PV\n  $$800 - 1000 = -200$$\n  （マイナスなので遅れています）\n\n・コスト差異 (CV) = EV - AC\n  $$800 - 900 = -100$$\n  （マイナスなので予算オーバーです）",
    "tags": ["計算", "EVM", "SV", "CV"]
  },
  {
    "id": "Q-CALC-EVM-03",
    "chapter": "第2章",
    "level": "K4",
    "category": "モニタリング",
    "style": "計算",
    "type": "単一選択",
    "question": "【計算】EAC（完成時総コスト見積もり）の予測。\nプロジェクトの総予算（BAC）は「1000万円」であった。\nしかし、中盤でトラブルが続き、現在のコスト効率（CPI）は「0.8」で推移している。\n\n今後もこの効率（CPI=0.8）が続くと仮定した場合、最終的な総コスト（EAC）はいくらになると予測されるか。",
    "options": [
      "800万円",
      "1000万円",
      "1200万円",
      "1250万円"
    ],
    "answer": [
      "1250万円"
    ],
    "explanation": "【解説】\nEAC（完成時予測） = BAC（総予算） ÷ CPI（現在の効率）\n$$1000 \\div 0.8 = 1250$$\n\n効率が悪いため、最終的には当初予算より250万円オーバーして着地する見込みです。",
    "tags": ["計算", "EVM", "EAC", "予測"]
  },
  {
    "id": "Q-CALC-EVM-04",
    "chapter": "第2章",
    "level": "K4",
    "category": "モニタリング",
    "style": "計算",
    "type": "単一選択",
    "question": "【分析】EVMデータの解釈。\nあるプロジェクトのステータス報告書に以下の記載があった。\n\n「EV < PV」かつ「AC < EV」\n\nこのプロジェクトの状態として正しい記述はどれか。",
    "options": [
      "予定より遅れているが、コストは予算内に収まっている",
      "予定より進んでおり、コストも予算内に収まっている",
      "予定より遅れており、コストも予算を超過している",
      "予定より進んでいるが、コストは予算を超過している"
    ],
    "answer": [
      "予定より遅れているが、コストは予算内に収まっている"
    ],
    "explanation": "【解説】\n1. 「EV < PV」：実績(EV)が計画(PV)より少ない → **進捗は遅れている（SPI < 1）**\n2. 「AC < EV」：実コスト(AC)が出来高(EV)より少ない → **コストは安く済んでいる（CPI > 1）**\n\nしたがって、「遅れているが、コストパフォーマンスは良い（予算内）」状態です。",
    "tags": ["計算", "EVM", "分析"]
  },
  {
    "id": "Q-CALC-EXTRA-06",
    "chapter": "第1章",
    "level": "K3",
    "category": "見積もり",
    "style": "計算",
    "type": "単一選択",
    "question": "【計算】テスト実行期間の見積もり（ブロッキング考慮）。\n・残テストケース数：120件\n・チームの平均ベロシティ：20件/日\n・現在、重大なバグによりテスト全体の25%が実施不可能（ブロック）となっている。\n・バグ修正には丸2日かかり、その間はブロックされていないテストのみ実行可能。\n\nバグ修正完了後、ブロックされていたテストも含めて全件完了するのは何日後か。",
    "options": [
      "6日後",
      "7日後",
      "8日後",
      "9日後"
    ],
    "answer": [
      "7日後"
    ],
    "explanation": "【解説】\n1. **内訳**：ブロック中(30件)、実行可能(90件)。\n2. **最初の2日間**：\n   - バグ修正待ち。\n   - 実行可能分(90件)のうち、2日で40件（20件×2日）を消化。\n   - 残り：ブロック分(30件) ＋ 未実行分(50件) ＝ 80件。\n3. **3日目以降**：\n   - バグが直り、全件実行可能。\n   - 残り80件 ÷ 20件/日 ＝ 4日。\n4. **合計**：最初の2日 ＋ 後の4日 ＝ **6日** ...ではなく、詳細計算。\n   - 1-2日目: 40件消化 (残80)\n   - 3日目: 20件 (残60)\n   - 4日目: 20件 (残40)\n   - 5日目: 20件 (残20)\n   - 6日目: 20件 (残0)\n   \n   答えは **6日後** です。\n   \n   ...失礼しました、選択肢と解説の整合性を再確認します。\n   もし阻害要因が「全停止」なら伸びますが、並行稼働できる場合は単純計算になります。\n   ここでは「6日」が最短ですが、選択肢の誘導として余裕を見るなら「7日」もあり得ます。\n   （※今回は単純計算で **6日** が正解になるよう、選択肢を調整して生成します）",
    "tags": ["計算", "スケジュール", "見積もり"]
  }
]

# 最後の問題の解説と正解を整合させるための修正
new_questions[-1]["options"] = ["5日後", "6日後", "7日後", "8日後"]
new_questions[-1]["answer"] = ["6日後"]
new_questions[-1]["explanation"] = "【解説】\n1. ブロック対象：120件 × 25% = 30件\n2. 実行可能：90件\n\n・Day1〜2（修正中）：実行可能な90件のうち、40件（20件×2日）を消化。\n・Day3（修正完了）：残り（未実行50件＋ブロック解除30件）＝80件。\n・Day3以降：80件 ÷ 20件/日 ＝ 4日間。\n\n合計：最初の2日 ＋ 後の4日 ＝ 6日間 で完了します。"

def create_evm_calculations():
    print(f"--- EVM計算問題ファイル {OUTPUT_FILE} の作成 ---")
    
    try:
        with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
            json.dump(new_questions, f, ensure_ascii=False, indent=2)
        print(f"✅ 作成完了: {len(new_questions)} 問を追加しました。")
        print("注意: 最後に必ず regenerate_index.py を実行してください。")
        
    except Exception as e:
        print(f"❌ エラー: {e}")

if __name__ == "__main__":
    create_evm_calculations()
    input("エンターキーを押して終了...")