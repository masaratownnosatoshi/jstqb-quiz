import json
import os

# 保存先ディレクトリ
OUTPUT_DIR = "."

# ==========================================
# Vol.97 新規問題データ定義
# ==========================================

# 1. 第1章 一般 (ch1_general_vol97.json)
q1_gen = [
    {
        "id": "Q1-GEN-V97-01",
        "chapter": "第1章",
        "level": "K3",
        "category": "一般",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【適用】テスト計画の更新（コントロール）。\nプロジェクト中盤で「主要なサードパーティ製APIの仕様変更」という予期せぬリスクが発生した。この影響で、統合テストの開始が2週間遅れる見込みである。\nこの状況下で、テストマネージャが取るべき最も適切な行動はどれか。",
        "options": [
            "遅延を取り戻すためにテストチームの残業時間を倍増させ、土日も稼働することで、当初のスケジュール通りにテストを完了させる計画に変更する（疲弊と品質低下のリスク）",
            "ステークホルダーと協議して、API変更の影響を受けない機能のテストを前倒しで実施するようスケジュールを組み替えるとともに、全体スケジュールの見直し（リリース日変更や機能削減）の可能性を提示する",
            "APIの仕様変更は開発チームの問題であるため、テストチームは関与せず、統合テストが可能になるまで待機して、遅れた分はテスト期間を短縮することで対応する（品質リスクの増大）",
            "テスト計画書を書き換えて、最初からそのAPIを使用しない前提のダミーデータによるテストに切り替え、本番接続テストは実施しないことにする（本番リスクの無視）"
        ],
        "answer": [
            "ステークホルダーと協議して、API変更の影響を受けない機能のテストを前倒しで実施するようスケジュールを組み替えるとともに、全体スケジュールの見直し（リリース日変更や機能削減）の可能性を提示する"
        ],
        "explanation": "【解説】\n予期せぬ遅延に対しては、単なる精神論（残業）や責任転嫁（待機）ではなく、スケジュールの組み替えとステークホルダーとの調整（期待値コントロール）を行うのがマネジメントの役割です。",
        "tags": ["第1章", "一般", "シナリオ", "K3"]
    },
    {
        "id": "Q1-GEN-V97-02",
        "chapter": "第1章",
        "level": "K4",
        "category": "一般",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【分析】欠陥密度の評価。\nあるモジュールのテスト結果：\n・欠陥密度が過去のプロジェクト平均よりも極端に高い。\n・発見された欠陥の多くは「仕様の不整合」に関連している。\nこのデータから導き出される仮説と推奨アクションは？",
        "options": [
            "モジュールの実装品質が著しく低いため、担当プログラマーを交代させ、コードを全て書き直すように指示する（根本原因が仕様にある可能性を無視）",
            "要件定義または設計フェーズの品質が低く、仕様バグが大量に混入している可能性が高いため、テストを一時中断して仕様書のインスペクション（再レビュー）を実施し、仕様を確定させてからテストを再開する",
            "テストケースが細かすぎて過剰な指摘をしている可能性があるため、テスト粒度を見直し、軽微な仕様不整合は無視するようにテスターに指示する（品質基準の引き下げ）",
            "欠陥密度が高いということは、それだけ多くのバグを除去できた証拠であり、品質は高いと判断して予定通りリリース準備を進める（潜在バグの残存リスク無視）"
        ],
        "answer": [
            "要件定義または設計フェーズの品質が低く、仕様バグが大量に混入している可能性が高いため、テストを一時中断して仕様書のインスペクション（再レビュー）を実施し、仕様を確定させてからテストを再開する"
        ],
        "explanation": "【解説】\n「仕様の不整合」が多い場合、コードを直す前に仕様を直さないと手戻りが無限に続きます。勇気を持ってテストを止め、上流（仕様）を修正するのが最速の道です。",
        "tags": ["第1章", "一般", "シナリオ", "K4"]
    }
]

# 2. 第2章 医療 (ch2_medical_vol97.json)
q2_med = [
    {
        "id": "Q2-MED-V97-01",
        "chapter": "第2章",
        "level": "K3",
        "category": "医療",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【適用】医療機器のリスクコントロール手段の優先順位。\n「ユーザーが誤って投薬量を10倍に設定してしまう」というハザード（使用エラー）が特定された。\nISO 14971に基づく、最も優先順位の高いリスクコントロール手段はどれか。",
        "options": [
            "取扱説明書に「投薬量は慎重に設定してください」という警告文を目立つように記載し、ユーザーに注意を促す（情報の提供による安全性）",
            "ユーザーインターフェースを設計変更し、極端な数値が入力された場合は警告ダイアログを表示するか、物理的に入力できないように制限をかける（設計による本質的安全設計）",
            "ユーザーに対する操作トレーニングを徹底し、認定を受けた看護師以外は操作できないように運用ルールを定める（トレーニングによる対応）",
            "このリスクは「ユーザーの不注意」に起因するものであるため、メーカー側の対策は不要とし、リスクを受容する（リスク管理の放棄）"
        ],
        "answer": [
            "ユーザーインターフェースを設計変更し、極端な数値が入力された場合は警告ダイアログを表示するか、物理的に入力できないように制限をかける（設計による本質的安全設計）"
        ],
        "explanation": "【解説】\nリスクコントロールの優先順位は「1. 本質的安全設計（設計で防ぐ）」「2. 防護手段（ガード等）」「3. 情報提供（マニュアル・警告）」の順です。警告文やトレーニングは優先度が低くなります。",
        "tags": ["第2章", "医療", "シナリオ", "K3"]
    }
]

# 3. 第2章 AWS (ch2_aws_vol97.json)
q2_aws = [
    {
        "id": "Q2-AWS-V97-01",
        "chapter": "第2章",
        "level": "K3",
        "category": "AWS",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【適用】AWSのパフォーマンス効率の検証。\n新しいWebアプリケーションの負荷テストを実施したところ、データベース（Amazon RDS）のCPU使用率が100%に張り付き、応答不能になった。\nこの問題を解決するための「クラウドネイティブな」アプローチとして最も適切なテスト・対策方針は？",
        "options": [
            "RDSのインスタンスタイプを、現在よりもCPU性能が高いものにスケールアップ（垂直分割）し、再度負荷テストを行って解決するか確認する",
            "アプリケーションのコードを修正し、データベースへのクエリ数を減らすチューニングを行うため、開発チームに差し戻す（クラウド機能の活用ではない）",
            "Amazon ElastiCache（Redis/Memcached）を導入して読み取りクエリをキャッシュし、DBへの負荷をオフロードする構成に変更して、その効果を検証するテストを行う",
            "データベースをRDSからオンプレミスの高性能サーバーに移行し、ハードウェアリソースを専有することでパフォーマンスを安定させる（クラウドのメリット放棄）"
        ],
        "answer": [
            "Amazon ElastiCache（Redis/Memcached）を導入して読み取りクエリをキャッシュし、DBへの負荷をオフロードする構成に変更して、その効果を検証するテストを行う"
        ],
        "explanation": "【解説】\n単なるスペックアップ（スケールアップ）も手ですが、クラウド設計のベストプラクティス（Design for Failure / Performance Efficiency）としては、キャッシュ層の導入によるオフロードが推奨されます。",
        "tags": ["第2章", "AWS", "シナリオ", "K3"]
    }
]

# 4. 第3章 一般 (ch3_general_vol97.json)
q3_gen = [
    {
        "id": "Q3-GEN-V97-01",
        "chapter": "第3章",
        "level": "K4",
        "category": "一般",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【分析】チームの心理的安全性。\n振り返り（Retrospective）の場で、メンバーが誰も発言せず、沈黙が続いている。特定のリーダーだけが「今回はこれがダメだった」と一方的に話している。\nこの状況が示唆する問題と、マネージャが取るべきアクションは？",
        "options": [
            "メンバーのやる気がないと判断し、全員に対して「もっと積極的に発言するように」と厳しく指導する（心理的安全性のさらなる低下）",
            "心理的安全性が欠如しており、メンバーが「発言すると非難される」と恐れている可能性がある。リーダーの発言を制止し、まずは「Good（良かったこと）」や「感謝」を共有する時間を設けて場の空気を変える",
            "振り返りは時間の無駄であるため廃止し、代わりにマネージャが作成した改善計画書を配布して実行させる（自律性の否定）",
            "発言しないメンバーを個別に呼び出し、人事評価に影響することを伝えて強制的に意見を言わせる（恐怖による管理）"
        ],
        "answer": [
            "心理的安全性が欠如しており、メンバーが「発言すると非難される」と恐れている可能性がある。リーダーの発言を制止し、まずは「Good（良かったこと）」や「感謝」を共有する時間を設けて場の空気を変える"
        ],
        "explanation": "【解説】\n沈黙の原因は「恐怖」であることが多いです。まずはポジティブな共有から入り、発言しても安全な場を作るファシリテーションが必要です。",
        "tags": ["第3章", "一般", "シナリオ", "K4"]
    }
]

# 5. 第1章 金融 (ch1_finance_vol97.json)
q1_fin = [
    {
        "id": "Q1-FIN-V97-01",
        "chapter": "第1章",
        "level": "K3",
        "category": "金融",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【適用】金融商品のテストデータ準備。\n「住宅ローン」の金利計算テストを行う。金利は「顧客ランク」「借入期間」「キャンペーン適用有無」の組み合わせで複雑に変動する。\n本番相当のデータバリエーションを確保するための最も適切なデータ準備手法は？",
        "options": [
            "本番環境から実際の顧客データをそのまま抽出し（個人情報含む）、テスト環境にインポートして使用する（セキュリティ・コンプライアンス違反のリスク）",
            "「ペアワイズ法（All-Pairs法）」等の組み合わせテスト技法を用いて、全ての因子（ランク・期間・キャンペーン）の組み合わせを網羅する最小限のテストデータセットを合成（作成）する",
            "開発者が手元で作成した数件のサンプルデータのみを使用し、複雑な組み合わせについては机上計算で確認する（テスト不足）",
            "全ての組み合わせ（数万通り）を手作業で入力してデータを作成し、網羅性を物理的な量で担保する（工数爆発）"
        ],
        "answer": [
            "「ペアワイズ法（All-Pairs法）」等の組み合わせテスト技法を用いて、全ての因子（ランク・期間・キャンペーン）の組み合わせを網羅する最小限のテストデータセットを合成（作成）する"
        ],
        "explanation": "【解説】\n金融システムでは本番データの利用は厳しく制限されます（マスキング必須）。論理的に網羅性を担保した合成データを作成するのがベストプラクティスです。",
        "tags": ["第1章", "金融", "シナリオ", "K3"]
    }
]

# ==========================================
# ファイル書き出し
# ==========================================
files = {
    "ch1_general_vol97.json": q1_gen,
    "ch2_medical_vol97.json": q2_med,
    "ch2_aws_vol97.json": q2_aws,
    "ch3_general_vol97.json": q3_gen,
    "ch1_finance_vol97.json": q1_fin
}

for filename, content in files.items():
    file_path = os.path.join(OUTPUT_DIR, filename)
    with open(file_path, 'w', encoding='utf-8') as f:
        json.dump(content, f, ensure_ascii=False, indent=2)
    print(f"Created: {filename}")

print("-" * 30)
print("完了: Vol.97 のファイル生成が完了しました。")