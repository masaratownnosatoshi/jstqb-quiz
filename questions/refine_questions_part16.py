import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第16弾・Vol.12 最終調整）
# ==========================================
fixes = {
    # ---------------------------
    # 第2章 医療 Vol.12 (ch2_medical_vol12.json)
    # ---------------------------
    "Q2-MED-V12-01": { # AI診断のリスク対応
        "options": [
            "開発者の主張通り、マニュアルに「医師が確認してください」と書いてリリースし、メーカーの責任を免除する",
            "「AIの過信（Automation Bias）」によるリスクを考慮し、誤検知が医師の判断ミスを誘発する可能性（ハザード）を評価した上で、追加の安全対策（注意喚起UIなど）を要求する",
            "AIモデルの「正解率（Accuracy）」のみを指標とし、臨床現場での「偽陰性（見逃し）」のリスクは運用でカバーする",
            "誤検知が多い特定の症例データを学習セットから除外し、見かけ上の精度を向上させる"
        ],
        "answer": ["「AIの過信（Automation Bias）」によるリスクを考慮し、誤検知が医師の判断ミスを誘発する可能性（ハザード）を評価した上で、追加の安全対策（注意喚起UIなど）を要求する"]
    },

    # ---------------------------
    # 第3章 クラウド Vol.12 (ch3_cloud_vol12.json)
    # ---------------------------
    "Q3-CLD-V12-01": { # ポストモーテムの形骸化
        "options": [
            "「担当者の不注意」を根本原因とし、再発防止策として「ダブルチェックの徹底」や「意識改革」をルール化する（精神論への逃げ）",
            "「なぜ確認不足が起きたのか？」「なぜ確認しにくいシステムだったのか？」とWhyを5回繰り返す（なぜなぜ分析）よう誘導し、プロセスや仕組みの改善案（自動チェック等）を導き出す",
            "障害を起こした担当者に「始末書」を書かせ、責任の所在を明確にすることで組織を引き締める",
            "ポストモーテムは時間の無駄であるため廃止し、修正パッチの作成のみに注力する"
        ],
        "answer": ["「なぜ確認不足が起きたのか？」「なぜ確認しにくいシステムだったのか？」とWhyを5回繰り返す（なぜなぜ分析）よう誘導し、プロセスや仕組みの改善案（自動チェック等）を導き出す"]
    },

    # ---------------------------
    # 第3章 金融 Vol.12 (ch3_finance_vol12.json)
    # ---------------------------
    "Q3-FIN-V12-01": { # ベンダーとの仕様言った言わない
        "options": [
            "ベンダーのスキル不足が原因であるため、契約を打ち切り、他社に乗り換える（コスト増・遅延リスク）",
            "仕様書の曖昧さを排除するために、発注側が受け入れ基準（Acceptance Criteria）を明確に定義し、契約や要件定義の段階で「完了の定義」としてベンダーと合意しておく",
            "ベンダーの作業をマイクロマネジメントし、すべてのコードを自社社員がレビューする（体制崩壊）",
            "「アジャイル開発だから仕様書は不要」と宣言し、動くものを見てから修正指示を出す（丸投げ）"
        ],
        "answer": ["仕様書の曖昧さを排除するために、発注側が受け入れ基準（Acceptance Criteria）を明確に定義し、契約や要件定義の段階で「完了の定義」としてベンダーと合意しておく"]
    },

    # ---------------------------
    # 第3章 一般 Vol.12 (ch3_general_vol12.json)
    # ---------------------------
    "Q3-GEN-V12-01": { # 自動化への抵抗
        "options": [
            "経営層からのトップダウン指示として自動化ツールの導入を強制し、従わないメンバーは評価を下げる",
            "「自動化は手動テストを置き換えるものではなく、退屈な作業を代行して、皆さんがより創造的なテスト（探索的テスト等）に集中するための武器だ」というビジョンを共有し、共感を得る",
            "抵抗勢力を排除するため、自動化チームを物理的に別フロアに隔離し、関わりを持たせない（分断）",
            "手動テストチームの給与を下げ、自動化エンジニアの給与を上げることで、経済的な動機付けを行う"
        ],
        "answer": ["「自動化は手動テストを置き換えるものではなく、退屈な作業を代行して、皆さんがより創造的なテスト（探索的テスト等）に集中するための武器だ」というビジョンを共有し、共感を得る"]
    },

    # ---------------------------
    # 第1章 AWS Vol.12 (ch1_aws_vol12.json)
    # ---------------------------
    "Q1-AWS-V12-01": { # クラウドのDRテスト
        "options": [
            "AWSのSLA（稼働率保証）があるため、利用者側での障害テストは不要であると判断する",
            "「カオスエンジニアリング」の手法を取り入れ、意図的にインスタンスを落とすなどの障害注入テストを定期的に（または継続的に）実施する体制に変える",
            "コスト削減のため、机上でのシミュレーション（Tabletop Exercise）のみを行い、実機での切り替え試験は省略する",
            "本番環境と全く同じ構成の待機系（ホットスタンバイ）を常時起動しておき、コスト度外視で安心を買う"
        ],
        "answer": ["「カオスエンジニアリング」の手法を取り入れ、意図的にインスタンスを落とすなどの障害注入テストを定期的に（または継続的に）実施する体制に変える"]
    },

    # ---------------------------
    # 第1章 金融 Vol.12 (ch1_finance_vol12.json)
    # ---------------------------
    "Q1-FIN-V12-01": { # 並行稼働テスト未実施
        "options": [
            "主要な1%の口座のみサンプリングチェックを行い、統計的に問題ないと判断してリリースする（全量照合の放棄）",
            "並行稼働中のデータ不整合は、顧客の預金残高ズレという致命的な「ステークホルダーリスク」に直結するため、リリース延期を強く進言する",
            "移行ツールが「正常終了」のログを出しているため、中身のデータ検証は省略可能とする",
            "リリース後に不整合が見つかった場合は、夜間バッチでこっそり補正する運用フローを組む"
        ],
        "answer": ["並行稼働中のデータ不整合は、顧客の預金残高ズレという致命的な「ステークホルダーリスク」に直結するため、リリース延期を強く進言する"]
    },

    # ---------------------------
    # 第1章 一般 Vol.12 (ch1_general_vol12.json)
    # ---------------------------
    "Q1-GEN-V12-01": { # テスト遅延リカバリ
        "options": [
            "テスターを3倍に増員し、コミュニケーションコストの増大を無視して人海戦術で乗り切る（ブルックスの法則の無視）",
            "テスト期間を短縮するため、回帰テストを「開発者の自己申告」ベースに切り替え、QAチームは新機能のみを見る",
            "リスク分析を再実施し、リスクレベルが「低」の機能のテストをスコープから外し（デスコープ）、高・中リスク機能にリソースを集中させる",
            "リリース日を延期できないため、残業と休日出勤でカバーするようチームに命令する（デスマーチ）"
        ],
        "answer": ["リスク分析を再実施し、リスクレベルが「低」の機能のテストをスコープから外し（デスコープ）、高・中リスク機能にリソースを集中させる"]
    },
    "Q1-GEN-V12-02": { # 仕様変更頻発への対応
        "options": [
            "仕様が完全に固まるまで（フィックスするまで）、テスト活動を一切開始しない（ウォーターフォールへの固執）",
            "詳細なテスト手順書の作成を止め、探索的テスト（Exploratory Testing）を主軸にしたセッションベースの管理に切り替える",
            "「リアクティブ（事後的）戦略」を採用し、完成したソフトウェアを見てからテスト設計を行うアプローチをとる",
            "開発チームに対し、仕様変更のたびにテスト計画書の修正版を提出するよう要求する（ドキュメント偏重）"
        ],
        "answer": [
            "詳細なテスト手順書の作成を止め、探索的テスト（Exploratory Testing）を主軸にしたセッションベースの管理に切り替える",
            "「リアクティブ（事後的）戦略」を採用し、完成したソフトウェアを見てからテスト設計を行うアプローチをとる"
        ]
    },

    # ---------------------------
    # 第2章 一般 Vol.12 (ch2_general_vol12.json)
    # ---------------------------
    "Q2-GEN-V12-01": { # レビューがてにをはばかり
        "options": [
            "レビューの時間を2倍に延長し、より細かくチェックさせる",
            "事前にスペルチェックツール等で形式的なミスを排除してからレビューに臨む",
            "「チェックリストベースドリーディング」を採用し、セキュリティ、パフォーマンス等の具体的な観点を各レビュアーに割り当てる（シナリオ/視点の付与）",
            "レビューアのスキル不足とみなし、マネージャーが一人ですべてのレビューを行う（属人化）"
        ],
        "answer": [
            "事前にスペルチェックツール等で形式的なミスを排除してからレビューに臨む",
            "「チェックリストベースドリーディング」を採用し、セキュリティ、パフォーマンス等の具体的な観点を各レビュアーに割り当てる（シナリオ/視点の付与）"
        ]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第16弾：問題データの修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()