import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第6弾）
# ==========================================
fixes = {
    # ---------------------------
    # 第3章 医療 Vol.3 (ch3_medical_vol3.json)
    # ---------------------------
    "Q3-MED-V3-01": { # 手順書への不満対応
        "options": [
            "「開発スピードを優先するため、ドキュメント作成は製品リリース後にまとめて行えばよい」と許可する（技術的負債の容認）",
            "「規制当局（FDA等）への説明責任を果たすために、プロセス遵守の証拠が必要なんだ。君の作業ログが患者の安全を守る盾になる」と意義を説く",
            "「手順書の作成と維持はテストチームの仕事ではないので、品質保証（QA）部門にすべて一任しよう」と責任を転嫁する",
            "「形式的な手順書は廃止し、アジャイル宣言に従って包括的なドキュメントよりも対話を重視しよう」と誤った解釈を伝える"
        ],
        "answer": ["「規制当局（FDA等）への説明責任を果たすために、プロセス遵守の証拠が必要なんだ。君の作業ログが患者の安全を守る盾になる」と意義を説く"]
    },

    # ---------------------------
    # 第1章 AWS Vol.4 (ch1_aws_vol4.json)
    # ---------------------------
    "Q1-AWS-V4-01": { # リージョンの定義
        "options": [
            "単一のデータセンターで構成され、高い物理的冗長性を持つ施設",
            "地理的に離れた独立した領域で、複数のAZ（アベイラビリティーゾーン）から構成される",
            "AWSのエッジロケーション（CDN拠点）を束ねた論理的なグループ",
            "IAMユーザーや請求情報を管理するための、グローバルで共通の管理単位"
        ],
        "answer": ["地理的に離れた独立した領域で、複数のAZ（アベイラビリティーゾーン）から構成される"]
    },
    "Q1-AWS-V4-02": { # FinOps不適切行動
        "options": [
            "開発環境のインスタンスを夜間停止するスケジューリング（Instance Scheduler）を導入する",
            "不要なEBSボリューム（Unattached EBS）や旧世代のスナップショットを定期的に棚卸しする",
            "コスト削減効果を測定するために、本番稼働中のデータベースを予告なく削除し、顧客への影響を確認する",
            "予算アラート（AWS Budgets）を設定し、予期せぬコスト急増を検知できるかテストする"
        ],
        "answer": ["コスト削減効果を測定するために、本番稼働中のデータベースを予告なく削除し、顧客への影響を確認する"]
    },

    # ---------------------------
    # 第2章 医療 Vol.3 (ch2_medical_vol3.json)
    # ---------------------------
    "Q2-MED-V3-01": { # 侵入テストのタイミング
        "options": [
            "開発初期段階から本番データ（患者のPII）を使用して実施し、リアリティを追求する",
            "リリース直前の検証済みの環境で行い、擬似データを使用する（本番データは使わない）",
            "リリース後に本番環境に対して抜き打ちで攻撃を行い、運用監視体制を試す（Red Teamingの誤用）",
            "セキュリティはファイアウォール製品で担保されているため、侵入テスト自体を実施しない"
        ],
        "answer": ["リリース直前の検証済みの環境で行い、擬似データを使用する（本番データは使わない）"]
    },

    # ---------------------------
    # 第3章 AWS Vol.3 (ch3_aws_vol3.json)
    # ---------------------------
    "Q3-AWS-V3-01": { # コスト意識の啓蒙
        "options": [
            "コスト情報は混乱を招くため開発チームには非公開とし、経理部門のみが管理する体制にする",
            "AWS Budgetsのアラートをチームチャットに通知し、全員がコスト状況をリアルタイムに見えるようにする",
            "すべてのAWSリソース作成に対して、マネージャーの承認印（ハンコ）を必須とし、物理的な承認フローを導入する",
            "クラウド利用を禁止してオンプレミス環境に回帰することで、固定費化によるコスト予見性を確保する"
        ],
        "answer": ["AWS Budgetsのアラートをチームチャットに通知し、全員がコスト状況をリアルタイムに見えるようにする"]
    },

    # ---------------------------
    # 第3章 クラウド Vol.3 (ch3_cloud_vol3.json)
    # ---------------------------
    "Q3-CLD-V3-01": { # エラーバジェット活用
        "options": [
            "エラーバジェット（許容ダウンタイム）が残っている間は、果敢にリリース（挑戦）して良い",
            "エラーバジェットが枯渇したら、機能リリースを凍結し、信頼性向上（バグ修正・安定化）に専念する",
            "エラーバジェットが枯渇した場合、計算ロジックを変更（目標値を下げる）して、見かけ上のバジェットを回復させてリリースを強行する",
            "エラーバジェットを超過した責任を問い、開発担当者の人事評価を下げることで再発を防止する"
        ],
        "answer": [
            "エラーバジェット（許容ダウンタイム）が残っている間は、果敢にリリース（挑戦）して良い",
            "エラーバジェットが枯渇したら、機能リリースを凍結し、信頼性向上（バグ修正・安定化）に専念する"
        ]
    },

    # ---------------------------
    # 第3章 金融 Vol.3 (ch3_finance_vol3.json)
    # ---------------------------
    "Q3-FIN-V3-01": { # 24/365対応への関与
        "options": [
            "運用は運用チームの責任であるため、テストチームは開発工程（リリース判定）までに関与を限定する",
            "障害発生時の緊急リリース手順（ホットフィックス）のテストプロセスを確立しておく",
            "夜間のシステム監視業務をテストチームが兼務し、人件費を削減する",
            "本番障害が発生した際は、正規のテスト手順をすべて省略し、開発者の修正パッチを即時適用するルールにする"
        ],
        "answer": ["障害発生時の緊急リリース手順（ホットフィックス）のテストプロセスを確立しておく"]
    },

    # ---------------------------
    # 第3章 一般 Vol.3 (ch3_general_vol3.json)
    # ---------------------------
    "Q3-GEN-V3-01": { # マズロー社会的欲求
        "options": [
            "高額な成果報酬（ボーナス）やストックオプションの付与（生理的・安全の欲求に近い）",
            "チームランチや懇親会、一体感のあるチームビルディング（帰属意識の醸成）",
            "個室の執務スペースや、専用のエグゼクティブチェアの提供（承認欲求）",
            "社内コンペでの優勝者に対する社長賞の授与（承認欲求）"
        ],
        "answer": ["チームランチや懇親会、一体感のあるチームビルディング（帰属意識の醸成）"]
    },
    "Q3-GEN-V3-02": { # コンフリクト協調
        "options": [
            "両者の主張を聞き、Win-Winとなる新しい解決策（例：自動化によるスピードと品質の両立）を模索する",
            "根本的な問題を共有し、対立を恐れずに議論を深める",
            "両者が互いに少しずつ譲歩し、痛み分けとなる妥協案（Compromising）を採用する",
            "対立によるチームの疲弊を避けるため、表面的な調和を保ち、問題を先送りする（Smoothing）"
        ],
        "answer": [
            "両者の主張を聞き、Win-Winとなる新しい解決策（例：自動化によるスピードと品質の両立）を模索する",
            "根本的な問題を共有し、対立を恐れずに議論を深める"
        ]
    },
    "Q3-GEN-V3-03": { # ソフトスキル面接
        "options": [
            "「Javaのガベージコレクションの仕組みを詳しく説明してください」（ハードスキル・知識）",
            "「過去にチーム内で対立が起きた時、あなたは具体的にどう行動しましたか？」（行動面接 STAR手法）",
            "「もしあなたがスーパーヒーローになれるとしたら、どんな能力が欲しいですか？」（仮定の質問・雑談）",
            "「あなたはストレス耐性がありますか？はい、か、いいえ、で答えてください」（クローズドクエスチョン・自己申告）"
        ],
        "answer": ["「過去にチーム内で対立が起きた時、あなたは具体的にどう行動しましたか？」（行動面接 STAR手法）"]
    },
    "Q3-GEN-V3-04": { # フィードバック手法
        "options": [
            "「サンドイッチ法」を使い、批判を褒め言葉で挟むことで、本質的な問題点を曖昧にして伝える",
            "半期ごとの人事考課面談までネガティブなフィードバックを溜め込み、一度にまとめて伝える",
            "具体的な事実に基づき、改善点と期待値を建設的に伝える（SBI型：Situation-Behavior-Impact）",
            "他の優秀なメンバーと比較し、「彼を見習え」と競争心を煽る言い方をする"
        ],
        "answer": ["具体的な事実に基づき、改善点と期待値を建設的に伝える（SBI型：Situation-Behavior-Impact）"]
    },
    "Q3-GEN-V3-05": { # バス係数
        "options": [
            "チームメンバーの通勤手段における、公共交通機関（バス）の利用率",
            "特定の1人が欠けると（バスに轢かれると）、プロジェクトが破綻する属人化状態の指標",
            "プロジェクトにおけるマネージャーとメンバーの人員比率",
            "チーム内のコミュニケーションパスの数（(n*(n-1))/2）"
        ],
        "answer": ["特定の1人が欠けると（バスに轢かれると）、プロジェクトが破綻する属人化状態の指標"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第6弾：問題データの修正を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()