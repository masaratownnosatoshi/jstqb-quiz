import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第34弾・Vol.54-56 用語定義の洗練）
# ==========================================
fixes = {
    # ---------------------------
    # 第3章 一般 Vol.55 (ch3_general_vol55.json)
    # ---------------------------
    "Q3-GEN-V55-01": { # ハードスキル定義
        "options": [
            "効果的なコミュニケーション能力（ソフトスキル）",
            "交渉力とリーダーシップ（ソフトスキル）",
            "テスト設計技法（境界値分析等）の適用能力や、ツールの使用スキル",
            "分析的思考や批判的思考（ソフトスキル）" # 「感情のコントロール」を修正
        ],
        "answer": ["テスト設計技法（境界値分析等）の適用能力や、ツールの使用スキル"]
    },

    # ---------------------------
    # 第1章 一般 Vol.54 (ch1_general_vol54.json)
    # ---------------------------
    "Q1-GEN-V54-05": { # 見積もり影響要因
        "options": [
            "テスト対象システムの品質（バグの多さ）",
            "テストチームのスキルと経験",
            "要件定義書の安定性（変更頻度）",
            "テスト環境の可用性や、テストデータの準備状況" # 「マウスのメーカー」を修正
        ],
        "answer": ["テスト環境の可用性や、テストデータの準備状況"],
        # 注: この設問は「影響しないもの」を選ぶ形式だったので、選択肢と正解を整合させる必要があります。
        # ここでは「考慮すべき要因」を並べた上で、問題文を「影響する要因として正しいものは？」に変えるか、
        # あるいは「考慮しなくてよいもの」として、もっともらしいが実は関係ない選択肢（例：開発者の好みのエディタ）を入れるかですが、
        # 今回は「考慮すべき重要な要因」を学ぶ意図で、全て「考慮すべきもの」に入れ替えた上で、
        # 問題文を「すべて考慮すべき要因である」と肯定的に捉える形式に変更するか、
        # もしくは、誤答として「開発者の給与」などを入れるのが適切です。
        # ここでは「誤答」として「開発チームの好みのランチ」のような明らかに無関係なものを入れるより、
        # 「プロジェクトのコードネーム」のような、関係ありそうで無いものにします。
        "options": [
            "テスト対象システムの品質（バグの多さ）",
            "テストチームのスキルと経験",
            "要件定義書の安定性（変更頻度）",
            "プロジェクトのコードネーム（名称）" # 修正案
        ],
        "answer": ["プロジェクトのコードネーム（名称）"]
    },

    # ---------------------------
    # 第2章 一般 Vol.56 (ch2_general_vol56.json)
    # ---------------------------
    "Q2-GEN-V56-03": { # ツールメトリクスの誤解
        "options": [
            "テストマネジメントツールは、テスト実行ステータスのスナップショット（合格/不合格/未実施）をリアルタイムに提供できる",
            "静的解析ツールは、コードの保守性や複雑度に関するメトリクスを提供できる",
            "性能テストツールは、システムの拡張性（スケーラビリティ）に関する情報を提供できる",
            "カバレッジツールは、コードの網羅率を測定できるが、テストケースの品質（バグ発見能力）までは測定できない" # 「人事評価」を修正
        ],
        # 問題文が「誤っているもの」を選ぶ形式なので、正解（誤り記述）を作る必要があります。
        # 上記の修正案は「正しい記述」になってしまっているので、
        # 「カバレッジツールは、テストの品質を完全に保証する指標を提供する」などの誤解記述にします。
        "options": [
            "テストマネジメントツールは、テスト実行ステータスのスナップショット（合格/不合格/未実施）をリアルタイムに提供できる",
            "静的解析ツールは、コードの保守性や複雑度に関するメトリクスを提供できる",
            "性能テストツールは、システムの拡張性（スケーラビリティ）に関する情報を提供できる",
            "カバレッジツールで100%を達成すれば、バグがないことを証明できる（カバレッジ＝品質保証という誤解）" # 修正案
        ],
        "answer": ["カバレッジツールで100%を達成すれば、バグがないことを証明できる（カバレッジ＝品質保証という誤解）"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第34弾：用語定義問題の最終仕上げを開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルを最適化しました。")

if __name__ == "__main__":
    refine_questions()