import json
import os

# 保存先ディレクトリ
OUTPUT_DIR = "."

# ==========================================
# Vol.99 新規問題データ定義
# ==========================================

# 1. 第3章 一般 (ch3_general_vol99.json)
q3_gen = [
    {
        "id": "Q3-GEN-V99-01",
        "chapter": "第3章",
        "level": "K4",
        "category": "一般",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【分析】欠陥検出率（DDP）の目標未達への対応。\n今回のプロジェクトではDDPの目標を90%に設定していたが、リリース後3ヶ月の実績は「80%」にとどまった。\n欠陥の内訳を分析したところ、「システムテストでは見つけにくい、特定の業務フローに依存した複雑なバグ」が市場で多く発見されていた。\n次回のプロジェクトに向けた改善策として最も適切なものはどれか。",
        "options": [
            "システムテストの工数を単純に倍増させ、既存のテストケースをより時間をかけて丁寧に実行することで、見逃しを防ぐ（テスト手法自体が変わっていないため効果が薄い）",
            "業務知識を持ったユーザーやドメインエキスパートを早期に巻き込み、ユースケーステストや探索的テスト（シナリオベース）を強化して、業務フローの網羅性を高める",
            "開発者の単体テストが不十分であることが原因であると断定し、カバレッジ100%を義務付けることで、ロジックレベルの欠陥を封じ込める（業務フローのバグは見つけられない）",
            "目標値の90%が高すぎたことが原因であるため、次回の目標値を現状の実力に合わせて80%に引き下げ、達成容易な目標にする（改善の放棄）"
        ],
        "answer": [
            "業務知識を持ったユーザーやドメインエキスパートを早期に巻き込み、ユースケーステストや探索的テスト（シナリオベース）を強化して、業務フローの網羅性を高める"
        ],
        "explanation": "【解説】\n業務フローに依存するバグは、単体テストや単純な機能テストでは見つけにくいです。ドメイン知識を活用したシナリオテストや探索的テストが特効薬となります。",
        "tags": ["第3章", "一般", "シナリオ", "K4"]
    }
]

# 2. 第1章 一般 (ch1_general_vol99.json)
q1_gen = [
    {
        "id": "Q1-GEN-V99-01",
        "chapter": "第1章",
        "level": "K3",
        "category": "一般",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【適用】テスト終了基準の「緩和」プロセス。\nリリース予定日が迫っているが、終了基準の一つである「全テストケースの実行完了」が達成できそうにない。\nテストマネージャとして、リスクコントロールの観点から提案すべき現実的なアクションはどれか。",
        "options": [
            "未実行のテストケースを全て「実行済み（Pass）」としてレポートを改ざんし、形式的に終了基準を満たしたことにしてリリースを承認してもらう（倫理規定違反）",
            "残りのテストケースに対してリスク評価を行い、リスクレベル「低」のものを今回スコープから外す（デスコープ）提案を行い、ステークホルダーの合意を得た上で基準を変更する",
            "テストが終わるまでリリースを無期限に延期することを強硬に主張し、ビジネス側の事情（商戦期など）は一切考慮しない（ビジネスゴールの無視）",
            "テストチーム全員に徹夜を命じ、疲労で判断力が低下した状態でも構わないので、とにかく数だけこなして全件実行を完了させる（品質リスクの増大）"
        ],
        "answer": [
            "残りのテストケースに対してリスク評価を行い、リスクレベル「低」のものを今回スコープから外す（デスコープ）提案を行い、ステークホルダーの合意を得た上で基準を変更する"
        ],
        "explanation": "【解説】\n終了基準は変更可能です。ただし、勝手に変えるのではなく「リスクベースでの判断」と「ステークホルダーの合意」が必須プロセスとなります。",
        "tags": ["第1章", "一般", "シナリオ", "K3"]
    }
]

# 3. 第2章 一般 (ch2_general_vol99.json)
q2_gen = [
    {
        "id": "Q2-GEN-V99-01",
        "chapter": "第2章",
        "level": "K3",
        "category": "一般",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【適用】静的解析ツールの誤検知（False Positive）対応。\n導入したセキュリティスキャンツールが、安全なコードに対しても大量の「脆弱性あり」アラートを出しており、開発者が対応に忙殺されている。\n運用を正常化するためのチューニング方針として適切なものはどれか。",
        "options": [
            "ツールが指摘するすべての箇所についてコードを修正し、たとえロジックが歪んでもツールのアラートをゼロにすることを最優先する（本末転倒）",
            "プロジェクトのコンテキスト（使用しているフレームワークや対策済みのライブラリ）に合わせてルールセットをカスタマイズし、明らかに誤検知であるルールを除外または抑制設定にする",
            "誤検知が多いツールは信用できないため即座に使用を中止し、今後はすべてのセキュリティチェックを目視レビューのみで行うことにする（効率と網羅性の低下）",
            "アラートの内容を確認せず、全ての警告を「リスク受容」としてステータス変更し、見かけ上の問題を解決する（脆弱性の見逃しリスク）"
        ],
        "answer": [
            "プロジェクトのコンテキスト（使用しているフレームワークや対策済みのライブラリ）に合わせてルールセットをカスタマイズし、明らかに誤検知であるルールを除外または抑制設定にする"
        ],
        "explanation": "【解説】\n静的解析ツールはデフォルト設定ではノイズが多いのが一般的です。プロジェクトに合わせたチューニング（Suppress設定など）が運用定着の鍵です。",
        "tags": ["第2章", "一般", "シナリオ", "K3"]
    }
]

# 4. 第1章 AWS (ch1_aws_vol99.json)
q1_aws = [
    {
        "id": "Q1-AWS-V99-01",
        "chapter": "第1章",
        "level": "K3",
        "category": "AWS",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【適用】サーバーレスアーキテクチャ（Lambda）のテスト戦略。\nAWS Lambdaを使用した機能において、コールドスタートによる「初回実行時の遅延」が懸念されている。\nこのパフォーマンスリスクを検証し、対策の効果を確認するためのテスト方法はどれか。",
        "options": [
            "Lambda関数のタイムアウト設定値を最大（15分）に延ばし、どれだけ時間がかかってもエラーにならないようにすることで、遅延の問題自体を隠蔽する（根本解決ではない）",
            "X-Ray等のトレースツールを有効化した状態で、一定時間放置した後の「初回リクエスト」と、その直後の「連続リクエスト」の応答時間を計測・比較し、Provisioned Concurrency等の対策要否を判断する",
            "Lambdaのメモリ割り当てを最小（128MB）に設定してコストを抑えつつ、遅延が発生したらユーザーに「リロードしてください」と案内する運用にする（UXの毀損）",
            "ローカル環境のPC上でLambdaのコードを実行し、そこでの処理時間が要件を満たしていれば、本番環境でも同じ速度で動くとみなす（クラウド環境特有のオーバーヘッドを無視）"
        ],
        "answer": [
            "X-Ray等のトレースツールを有効化した状態で、一定時間放置した後の「初回リクエスト」と、その直後の「連続リクエスト」の応答時間を計測・比較し、Provisioned Concurrency等の対策要否を判断する"
        ],
        "explanation": "【解説】\nサーバーレス特有のコールドスタート問題は、実環境での計測（X-Ray等）が必須です。対策としてはProvisioned Concurrency（事前の暖機運転）の検討などが挙げられます。",
        "tags": ["第1章", "AWS", "シナリオ", "K3"]
    }
]

# 5. 第2章 金融 (ch2_finance_vol99.json)
q2_fin = [
    {
        "id": "Q2-FIN-V99-01",
        "chapter": "第2章",
        "level": "K3",
        "category": "金融",
        "style": "シナリオ",
        "type": "単一選択",
        "question": "【適用】帳票出力機能の検証。\n銀行の月次取引明細書（PDF）において、特定の文字（外字や特殊記号）が文字化けする不具合が発生した。\n再発防止のための回帰テストとして、最も効果的なアプローチはどれか。",
        "options": [
            "生成されたPDFファイルを目視で一枚ずつ確認し、文字化けがないかをチェックする作業を、毎月のリリースのたびに手動で行う（工数が膨大でヒューマンエラーのリスクあり）",
            "過去に文字化けした文字コードを含むテストデータセットを作成し、PDF生成ツールから出力されたテキスト情報を抽出（テキストマイニング）して、期待値と自動比較する仕組みを導入する",
            "文字化けはプリンタドライバの問題である可能性が高いため、アプリケーション側のテストは行わず、ユーザーのプリンタ設定を変更してもらうようマニュアルを改訂する（責任転嫁）",
            "特殊文字の使用をシステム全体で禁止し、顧客の氏名などに外字が含まれている場合は、類似の標準文字に勝手に置き換えて登録する（顧客情報の正確性毀損）"
        ],
        "answer": [
            "過去に文字化けした文字コードを含むテストデータセットを作成し、PDF生成ツールから出力されたテキスト情報を抽出（テキストマイニング）して、期待値と自動比較する仕組みを導入する"
        ],
        "explanation": "【解説】\n目視確認は限界があります。PDFからのテキスト抽出・比較による自動化が、文字化けやレイアウト崩れの回帰テストとして有効です。",
        "tags": ["第2章", "金融", "シナリオ", "K3"]
    }
]

# ==========================================
# ファイル書き出し
# ==========================================
files = {
    "ch3_general_vol99.json": q3_gen,
    "ch1_general_vol99.json": q1_gen,
    "ch2_general_vol99.json": q2_gen,
    "ch1_aws_vol99.json": q1_aws,
    "ch2_finance_vol99.json": q2_fin
}

for filename, content in files.items():
    file_path = os.path.join(OUTPUT_DIR, filename)
    with open(file_path, 'w', encoding='utf-8') as f:
        json.dump(content, f, ensure_ascii=False, indent=2)
    print(f"Created: {filename}")

print("-" * 30)
print("完了: Vol.99 のファイル生成が完了しました。")