import json
import os
import glob

# ファイルが保存されているディレクトリ
BASE_DIR = "."

# ==========================================
# 修正データ定義（第24弾・Vol.31-33 完結編）
# ==========================================
fixes = {
    # ---------------------------
    # 第1章 一般 Vol.32 (ch1_general_vol32.json)
    # ---------------------------
    "Q1-GEN-V32-01": { # オフショア異文化コミュニケーション
        "options": [
            "報告内容を鵜呑みにし、「順調なら問題ない」と判断して、残りのテスト期間を短縮してコストを浮かす（楽観性バイアス）",
            "「ハイコンテクスト文化（空気を読む）」と「ローコンテクスト文化（言われたことだけやる）」のギャップ、または「権威への服従（Noと言えない）」文化が影響している可能性がある。対策として、「順調か？」というYes/No質問を避け、「今日完了したチケットを見せてほしい」「この手順をどう理解したか説明してほしい」といった具体的・客観的な確認プロセスに変更する",
            "日本語でのコミュニケーションを強制し、従わない場合はペナルティを科す（本質的な解決にならない）",
            "詳細なマニュアルを渡したのだから、読まない彼らが悪いとして放置する"
        ],
        "answer": ["「ハイコンテクスト文化（空気を読む）」と「ローコンテクスト文化（言われたことだけやる）」のギャップ、または「権威への服従（Noと言えない）」文化が影響している可能性がある。対策として、「順調か？」というYes/No質問を避け、「今日完了したチケットを見せてほしい」「この手順をどう理解したか説明してほしい」といった具体的・客観的な確認プロセスに変更する"]
    },

    # ---------------------------
    # 第2章 一般 Vol.32 (ch2_general_vol32.json)
    # ---------------------------
    "Q2-GEN-V32-01": { # ツール廃棄リスク
        "options": [
            "ツールAのライセンス料を節約するため、データ移行計画を立てずに即座にサーバーを停止・廃棄する（資産の喪失）",
            "過去のテストデータ（証跡）が参照できなくなるリスク。対策は、全データをツールBに移行するか、移行できないデータについてはツールAから「読み取り専用形式（PDF、CSV、HTML等）」でエクスポートし、アーカイブとして安全な場所に保管する",
            "移行作業が面倒なため、新旧両方のツールを無期限に並行稼働させ、現場の判断で使い分けさせる（データの分断・二重管理）",
            "ツールBが使いにくいという苦情を避けるため、ツールAの延命措置をメーカーに高額で依頼する"
        ],
        "answer": ["過去のテストデータ（証跡）が参照できなくなるリスク。対策は、全データをツールBに移行するか、移行できないデータについてはツールAから「読み取り専用形式（PDF、CSV、HTML等）」でエクスポートし、アーカイブとして安全な場所に保管する"]
    },

    # ---------------------------
    # 第2章 一般 Vol.33_2 (ch2_general_vol33_2.json)
    # ---------------------------
    "Q2-GEN-V33-03": { # フェーズ封じ込め失敗
        "options": [
            "弱点：システムテストで見つかっているので結果オーライである。\\n改善策：現状維持。",
            "弱点：欠陥の「フェーズ封じ込め（Phase Containment）」ができておらず、下流工程への流出コスト（内部失敗コスト）が増大している。\\n改善策：単体テスト（Unit Test）の強化や、コードレビューの徹底により、コーディングバグをその工程内で除去する施策を行う。",
            "弱点：コーディング品質が低い。\\n改善策：欠陥を出した開発者に罰金を科す。",
            "弱点：システムテストの期間が短い。\\n改善策：システムテスト期間を延長して、バグ出しに専念する（対処療法）。"
        ],
        "answer": ["弱点：欠陥の「フェーズ封じ込め（Phase Containment）」ができておらず、下流工程への流出コスト（内部失敗コスト）が増大している。\\n改善策：単体テスト（Unit Test）の強化や、コードレビューの徹底により、コーディングバグをその工程内で除去する施策を行う。"]
    },

    # ---------------------------
    # 第1章 一般 Vol.31 (ch1_general_vol31.json)
    # ---------------------------
    "Q1-GEN-V31-01": { # リスクベースモニタリング
        "options": [
            "モジュールD（高リスク・高欠陥）は品質が安定していないため、探索的テストの追加を検討する",
            "モジュールA（中リスク・高欠陥）は予想以上に品質が悪い（欠陥の偏在）ため、終了基準を厳しくし（消化率95%等）、追加テストを行う",
            "モジュールB（高リスク・低欠陥）は「テストがザル」な可能性があるため、テストケースの有効性をレビューする",
            "モジュールDは計画時点では「低リスク」だったので、欠陥が多くても無視してよい。スケジュールの遵守を最優先とし、これ以上の対策は行わない（状況変化への不適応）"
        ],
        "answer": ["モジュールDは計画時点では「低リスク」だったので、欠陥が多くても無視してよい。スケジュールの遵守を最優先とし、これ以上の対策は行わない（状況変化への不適応）"]
    }
}

def refine_questions():
    all_files = glob.glob(os.path.join(BASE_DIR, "*.json"))
    updated_count = 0

    print("第24弾（完）：最終調整を開始します...")

    for file_path in all_files:
        filename = os.path.basename(file_path)
        if filename.endswith(".py") or filename == "index.json":
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if not isinstance(data, list):
                continue

            file_modified = False
            
            for q in data:
                q_id = q.get("id")
                
                if q_id in fixes:
                    fix_data = fixes[q_id]
                    
                    if "options" in fix_data:
                        q["options"] = fix_data["options"]
                    if "answer" in fix_data:
                        q["answer"] = fix_data["answer"]
                    if "explanation" in fix_data:
                        q["explanation"] = fix_data["explanation"]

                    print(f"  修正適用: {q_id} ({filename})")
                    file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                updated_count += 1
                
        except Exception as e:
            print(f"  読み込みエラー: {filename} - {e}")

    print("-" * 30)
    print(f"完了: 合計 {updated_count} ファイルの問題を修正しました。")

if __name__ == "__main__":
    refine_questions()