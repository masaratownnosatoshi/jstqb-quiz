import json
import os
import glob

OUTPUT_DIR = "."

# IDごとの正しいデータ定義（巻き添えで壊れたものを個別に指定）
fix_map = {
    # --- ch1_general_vol77.json ---
    "Q1-GEN-V77-01": { # スケジュール調整（依存関係考慮）
        "options": [
            "TC1（高）→ TC2（中・前提）→ TC3（高）の順で実施し、時間がなければTC4（低）をカットする",
            "リスクの高い順（TC1 → TC3 → TC2 → TC4）に実施する（依存関係は無視する）",
            "簡単なTC4から順に実施して、消化件数を稼ぐ",
            "すべてのテストケースを少しずつ実施する"
        ],
        "answer": ["TC1（高）→ TC2（中・前提）→ TC3（高）の順で実施し、時間がなければTC4（低）をカットする"]
    },
    "Q1-GEN-V77-02": { # 終了基準（残存リスク）
        "options": [
            "残存リスクが5%であり、基準（3%未満）を満たしていないため、テスト完了とは認めず、修正と再テストを指示する",
            "テスト実行自体は完了しているので、合格としてリリースする",
            "残存リスクの数値目標はあくまで目安なので、マネージャの勘で判断する",
            "重要機能であっても、1件くらいなら無視してよい"
        ],
        "answer": ["残存リスクが5%であり、基準（3%未満）を満たしていないため、テスト完了とは認めず、修正と再テストを指示する"]
    },
    # Q1-GEN-V77-03 (3点見積もり計算) は元のスクリプトで偶然合っているので修正不要

    # --- ch2_general_vol90.json ---
    "Q2-GEN-V90-01": { # レビューメトリクス（準備早すぎ）
        "options": [
            "準備速度（10ページ/時）が速すぎて十分に読めておらず、かつ会議も慎重すぎて進んでいない、または誰も欠陥を見つけられずに沈黙している可能性がある",
            "非常に効率的にレビューが行われており、品質が高い状態である",
            "準備時間は適切だが、会議時間が長すぎるため、ファシリテーションに問題がある",
            "欠陥が0件なのは設計品質が完璧である証拠なので、何も問題はない"
        ],
        "answer": ["準備速度（10ページ/時）が速すぎて十分に読めておらず、かつ会議も慎重すぎて進んでいない、または誰も欠陥を見つけられずに沈黙している可能性がある"]
    },
    # Q2-GEN-V90-02 (ROI計算) は元のスクリプトで偶然合っているので修正不要

    # --- ch2_general_vol92.json ---
    # Q2-GEN-V92-01 (TCO計算) は元のスクリプトで偶然合っているので修正不要
    "Q2-GEN-V92-02": { # 再発防止（境界値）
        "options": [
            "静的解析ツールや単体テストで、入力値検証（バリデーション）のロジックを自動チェックするルールを追加する",
            "開発者に「もっと注意してコードを書くように」と精神論を説く",
            "テスト担当者を増員し、全ての手動テストケースで境界値チェックを二重に行う",
            "運用でカバーすることにし、開発プロセスは変更しない"
        ],
        "answer": ["静的解析ツールや単体テストで、入力値検証（バリデーション）のロジックを自動チェックするルールを追加する"]
    },

    # --- ch1_finance_vol76.json ---
    # Q1-FIN-V76-01 (バッチ計算) はOK
    "Q1-FIN-V76-02": { # 監査証跡
        "options": [
            "操作前の値（Before）と操作後の値（After）の両方",
            "操作した人の年齢と性別",
            "操作した端末のメーカー名",
            "操作にかかった秒数のみ"
        ],
        "answer": ["操作前の値（Before）と操作後の値（After）の両方"]
    },

    # --- ch1_general_vol9.json ---
    "Q1-GEN-V9-01": { # 3点見積もり期待値 (5,11,23 -> 12)
        "options": ["10人日", "11人日", "12人日", "13人日"],
        "answer": ["12人日"]
    },
    "Q1-GEN-V9-02": { # 自動化ROI (損益分岐点)
        "options": ["4回目", "5回目", "6回目", "10回目"],
        "answer": ["6回目"]
    },
    # Q1-GEN-V9-03 (RPN計算) はOK
    "Q1-GEN-V9-04": { # 標準偏差 (10, 22 -> 2)
        "options": ["1時間", "2時間", "3時間", "6時間"],
        "answer": ["2時間"]
    },

    # --- ch1_general_vol46.json ---
    # Q1-GEN-V46-01 (EVM) はOK
    "Q1-GEN-V46-02": { # 残存バグ予測 (50 - 35 = 15)
        "options": ["5件", "15件", "35件", "50件"],
        "answer": ["15件"]
    },

    # --- ch1_general_vol51.json ---
    "Q1-GEN-V51-01": { # 開始基準（不適切）
        "options": [
            "すべての重要バグが修正されていること（これは終了基準）",
            "テスト環境が構築され、利用可能であること",
            "テストツールがインストールされ、動作確認済みであること",
            "テスト計画書が承認されていること"
        ],
        "answer": ["すべての重要バグが修正されていること（これは終了基準）"]
    },
    # Q1-GEN-V51-02 (FP計算) はOK
    "Q1-GEN-V51-03": { # リスク低・低（受容）
        "options": [
            "受容（Accept）：特別なテストは行わず、発生したら対応する",
            "回避（Avoid）：その機能を削除する",
            "転嫁（Transfer）：保険に入る",
            "軽減（Mitigate）：徹底的にテストする"
        ],
        "answer": ["受容（Accept）：特別なテストは行わず、発生したら対応する"]
    },
    "Q1-GEN-V51-04": { # モデルベースド戦略
        "options": [
            "システムの振る舞いや利用状況をモデル化し、そこからテストケースを導出するアプローチ",
            "過去の欠陥データに基づいてテストするアプローチ（分析的）",
            "経験豊富なテスターの直感に頼るアプローチ（経験ベース）",
            "規格や標準に準拠するアプローチ（プロセス準拠）"
        ],
        "answer": ["システムの振る舞いや利用状況をモデル化し、そこからテストケースを導出するアプローチ"]
    },
    "Q1-GEN-V51-05": { # 不適切なコントロール
        "options": [
            "テストを中止し、そのままリリースする",
            "リリース延期を提案する",
            "テストのスコープ（範囲）を縮小し、重要機能に集中する",
            "テスト要員を追加するよう交渉する"
        ],
        "answer": ["テストを中止し、そのままリリースする"]
    }
}

def fix_mixed_questions():
    print("--- ID指定による個別修正を開始 ---")
    
    json_files = glob.glob(os.path.join(OUTPUT_DIR, "*.json"))
    fixed_count = 0

    for file_path in json_files:
        if "index.json" in file_path:
            continue
            
        filename = os.path.basename(file_path)
        file_modified = False
        
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if isinstance(data, list):
                for q in data:
                    q_id = q.get("id")
                    
                    # 定義リストにIDがあれば修正を適用
                    if q_id in fix_map:
                        print(f"修正対象IDを発見: {q_id} (in {filename})")
                        
                        target_data = fix_map[q_id]
                        q["options"] = target_data["options"]
                        q["answer"] = target_data["answer"]
                        
                        file_modified = True

            if file_modified:
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                print(f"保存完了: {filename}")
                fixed_count += 1

        except Exception as e:
            print(f"エラー: {filename} ({e})")

    print("-" * 30)
    print(f"完了: {fixed_count} ファイルに対し、個別ID修正を行いました。")
    print("エンターキーを押して終了してください...")

if __name__ == "__main__":
    fix_mixed_questions()
    input()